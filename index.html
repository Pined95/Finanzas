<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFinance | Titanium v2.0</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* === TITANIUM DESIGN SYSTEM v2.0 === */
        :root { 
            --bg: #0b0f19; 
            --card-bg: #151b2b; 
            --input-bg: #1e2532;
            --text: #ffffff; 
            --text-muted: #94a3b8; 
            --primary: #6366f1; 
            --primary-dark: #4338ca;
            --accent: #8b5cf6;
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --info: #0ea5e9; 
            --pending: #fbbf24;
            --radius: 24px;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.6);
        }

        /* Reset & Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 130px; overflow-x: hidden; min-height: 100vh; }
        
        /* Utilidades */
        .hidden { display: none !important; }
        .blur-text { filter: blur(8px); transition: filter 0.3s; user-select: none; }
        .blur-text:hover { filter: blur(0); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.7rem; }
        .font-bold { font-weight: 700; }
        .text-muted { color: var(--text-muted); }
        
        /* Loading Screen */
        #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s; pointer-events: none; opacity: 0; }
        #loading-overlay.active { opacity: 1; pointer-events: all; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(99, 102, 241, 0.3); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: var(--card-bg); color: white; padding: 16px 20px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; transform: translateY(-20px); opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid rgba(255,255,255,0.1); pointer-events: all; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--info); }

        /* Login Screen */
        #auth-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; background: radial-gradient(circle at top right, #1e1b4b, var(--bg)); }
        
        /* Layout Principal */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; opacity: 0; transform: translateY(10px); transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .container.loaded { opacity: 1; transform: translateY(0); }

        /* Header */
        .header { padding: 10px 0 20px; }
        .privacy-toggle { background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; }
        .privacy-toggle.active { background: var(--primary); border-color: var(--primary); color: white; }

        /* Navegaci√≥n (Tabs & Pills) */
        .tabs { background: #0f131f; padding: 4px; border-radius: 16px; display: flex; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .tab-btn { flex: 1; text-align: center; padding: 10px; border-radius: 12px; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; position: relative; }
        .tab-btn.active { background: var(--card-bg); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .tab-btn.locked { opacity: 0.6; }
        .tab-btn.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; position: absolute; right: 12px; top: 12px; font-size: 0.7rem; }

        .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 20px; -ms-overflow-style: none; scrollbar-width: none; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-pill { white-space: nowrap; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.05); color: var(--text-muted); font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .filter-pill.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(99,102,241,0.3); }

        /* Widgets & Cards */
        .widget { padding: 24px; border-radius: var(--radius); margin-bottom: 20px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); box-shadow: var(--shadow); }
        
        /* Widget Cerebro */
        .brain-widget { background: linear-gradient(135deg, #4f46e5, #312e81); border:none; }
        .brain-widget::before { content:''; position: absolute; top:-50%; right:-50%; width:100%; height:100%; background: radial-gradient(circle, rgba(255,255,255,0.2), transparent); filter: blur(40px); }
        
        /* Resumen Financiero */
        .summary-card { background: var(--card-bg); }
        .net-val { font-size: 2.8rem; font-weight: 800; margin: 10px 0; letter-spacing: -1.5px; line-height: 1; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; }
        .stat-item span:first-child { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; letter-spacing: 0.5px; }
        .stat-item span:last-child { font-size: 1.2rem; font-weight: 700; }

        /* Carrusel de Cuentas */
        .acc-list { display: flex; overflow-x: auto; gap: 16px; padding: 10px 5px 30px; scroll-snap-type: x mandatory; -ms-overflow-style: none; scrollbar-width: none; }
        .acc-list::-webkit-scrollbar { display: none; }
        .bank-card { flex: 0 0 280px; min-height: 170px; background: var(--card-bg); border-radius: 22px; padding: 20px; scroll-snap-align: start; cursor: pointer; position: relative; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 8px 20px rgba(0,0,0,0.3); transition: transform 0.2s; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        .bank-card:active { transform: scale(0.96); }
        
        .card-data-row { display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 5px; padding-top: 5px; border-top: 1px dashed rgba(255,255,255,0.1); color: var(--text-muted); }

        /* Centinela Alerts & Badges */
        .sentinel-alert { position: absolute; top: 0; right: 0; font-size: 0.65rem; padding: 4px 10px; border-bottom-left-radius: 16px; font-weight: 700; letter-spacing: 0.5px; }
        .sentinel-alert.danger { background: var(--danger); color: white; }
        .sentinel-alert.warning { background: var(--warning); color: #000; }
        
        .owner-badge { position: absolute; top: 15px; right: 15px; font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; font-weight: 700; background: rgba(0,0,0,0.4); text-transform: uppercase; }
        .owner-badge.joint { background: var(--accent); color: white; }

        /* Lista de Transacciones */
        .section-title { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); margin: 30px 0 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .tx-list { display: flex; flex-direction: column; gap: 12px; }
        .tx-item { background: var(--card-bg); padding: 16px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }
        .tx-item:active { background: rgba(255,255,255,0.05); }
        .tx-icon { width: 44px; height: 44px; background: rgba(255,255,255,0.03); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-size: 1.1rem; }

        /* Modales */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(6px); opacity: 0; transition: opacity 0.3s; }
        .modal.open { display: flex; opacity: 1; }
        .sheet { background: #1a202e; width: 100%; max-width: 550px; border-radius: 32px 32px 0 0; padding: 30px; max-height: 90vh; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.1); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        .modal.open .sheet { transform: translateY(0); }
        .sheet::-webkit-scrollbar { display: none; }

        /* Formularios */
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 18px; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; color: white; font-size: 1rem; outline: none; transition: border-color 0.2s; font-family: inherit; -webkit-appearance: none; }
        input:focus, select:focus { border-color: var(--primary); background: #232b3a; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Strat Card */
        .strat-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 16px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; }
        .strat-card:active { background: rgba(255,255,255,0.08); }
        .strat-card.urgent { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger); }
        .strat-card.ok { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--success); text-align: center; }

        /* Botones */
        .btn { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: transform 0.1s, opacity 0.2s; font-family: inherit; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-text { background: transparent; color: var(--text-muted); margin-top: 5px; }
        .btn-danger { color: var(--danger); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-sm { padding: 10px 16px; font-size: 0.85rem; width: auto; margin: 0; }

        /* Floating Actions */
        .fab { position: fixed; bottom: 30px; right: 25px; width: 64px; height: 64px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: white; box-shadow: 0 10px 25px rgba(99,102,241,0.5); z-index: 100; cursor: pointer; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.05); }
        .fab-mini { position: fixed; bottom: 110px; right: 35px; width: 48px; height: 48px; background: var(--pending); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #1e1b4b; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 90; cursor: pointer; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay"><div class="spinner"></div><div style="margin-top:20px; font-weight:600; letter-spacing:1px; font-size:0.9rem">CARGANDO DATOS...</div></div>

<div id="auth-screen">
    <div style="width:80px; height:80px; background:var(--primary); border-radius:24px; display:flex; align-items:center; justify-content:center; margin-bottom:30px; box-shadow:0 0 40px rgba(99,102,241,0.4)">
        <i class="fas fa-layer-group" style="font-size: 2.5rem; color: white;"></i>
    </div>
    <h1 style="margin:0; font-weight:800; letter-spacing:-1px; font-size:2.5rem">SmartFinance</h1>
    <p style="color:var(--text-muted); margin-bottom:50px; font-weight:300; letter-spacing:1px">Titanium v2.0</p>
    <button class="btn btn-primary" style="max-width:300px; display:flex; align-items:center; justify-content:center; gap:12px" onclick="login()">
        <i class="fab fa-google"></i> Continuar con Google
    </button>
</div>

<div class="container" id="app-screen" style="display:none">
    
    <div class="header flex-between">
        <div>
            <div style="display:flex; gap:10px; align-items:center">
                <small class="font-bold text-muted">HOLA,</small>
                <div class="privacy-toggle" onclick="togglePrivacy()">
                    <i class="fas fa-eye"></i> <span id="privacy-label">Visible</span>
                </div>
            </div>
            <h2 id="uName" style="margin:5px 0 0; font-weight:800">Usuario</h2>
        </div>
        <div style="display:flex; gap:10px">
            <div onclick="openModal('modalSettings')" style="width:44px; height:44px; background:rgba(255,255,255,0.05); border-radius:14px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(255,255,255,0.05)"><i class="fas fa-cog"></i></div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-btn active" id="tabMe" onclick="setFilter('me')">M√≠o</div>
        <div class="tab-btn locked" id="tabPartner" onclick="unlockSync('partner')">Pareja</div>
        <div class="tab-btn locked" id="tabAll" onclick="unlockSync('all')">Todo</div>
    </div>

    <div class="filter-scroll">
        <div class="filter-pill active" id="ft-all" onclick="setTypeFilter('all')">Todas</div>
        <div class="filter-pill" id="ft-debit" onclick="setTypeFilter('debit')"><i class="fas fa-wallet"></i> Efectivo</div>
        <div class="filter-pill" id="ft-credit" onclick="setTypeFilter('credit')"><i class="fas fa-credit-card"></i> Cr√©dito</div>
    </div>

    <div class="widget brain-widget">
        <div class="flex-between" style="margin-bottom:15px; position:relative; z-index:2">
            <span class="font-bold text-sm" style="color:#e0e7ff; letter-spacing:1px; display:flex; align-items:center; gap:8px"><i class="fas fa-brain"></i> BRAIN AI</span>
            <span id="brain-badge" class="text-xs" style="background:rgba(255,255,255,0.2); padding:4px 10px; border-radius:20px; font-weight:700">ANALIZANDO</span>
        </div>
        <div id="brain-msg" style="font-size:1.1rem; font-weight:600; color:white; line-height:1.4; margin-bottom:25px; position:relative; z-index:2">
            Calculando salud financiera...
        </div>
        <div class="row-2" style="position:relative; z-index:2">
            <button class="btn btn-sm" style="background:rgba(255,255,255,0.2); backdrop-filter:blur(5px)" onclick="openStrategyModal()"><i class="fas fa-calculator"></i> Estrategia</button>
            <button class="btn btn-sm" style="background:rgba(255,255,255,0.1); backdrop-filter:blur(5px)" onclick="openModal('modalPlanning')"><i class="fas fa-calendar-alt"></i> Planificar</button>
        </div>
    </div>

    <div class="widget summary-card">
        <div class="flex-between">
            <small class="font-bold text-muted">PATRIMONIO NETO</small>
            <i class="fas fa-chart-pie text-muted"></i>
        </div>
        <div class="net-val" id="netDisplay">$0.00</div>
        <div class="stat-grid">
            <div class="stat-item"><span>Liquidez (Efectivo)</span><span style="color:var(--success)" id="assetDisplay">--</span></div>
            <div class="stat-item"><span>Deuda Total</span><span style="color:var(--danger)" id="debtDisplay">--</span></div>
            <div class="stat-item"><span>Por Cobrar</span><span style="color:var(--pending)" id="pendDisplay">--</span></div>
            <div class="stat-item"><span>Sueldo Proyectado</span><span style="color:var(--info)" id="goalsDisplay">--</span></div>
        </div>
    </div>

    <div class="section-title">
        <span>Cuentas</span>
        <span style="color:var(--primary); font-size:0.75rem; cursor:pointer" onclick="openAccModal()">+ A√±adir</span>
    </div>
    <div class="acc-list" id="accList"></div>

    <div class="section-title" style="margin-top:10px">
        <span>Movimientos</span>
        <input type="month" id="dateFilter" style="background:transparent; border:none; color:var(--text); font-weight:700; font-family:inherit; font-size:0.8rem; text-align:right; cursor:pointer" onchange="loadTransactions()">
    </div>
    <div id="txList" class="tx-list" style="min-height:200px"></div>

</div>

<div class="fab" onclick="openTxModal()"><i class="fas fa-plus"></i></div>
<div class="fab-mini" onclick="openCollectModal()"><i class="fas fa-hand-holding-dollar"></i></div>

<div class="modal" id="modalStrategy">
    <div class="sheet">
        <h3 style="margin-top:0"><i class="fas fa-chess"></i> Estrategia de Pago</h3>
        <p class="text-sm text-muted" style="margin-bottom:25px">Priorizaci√≥n inteligente basada en fechas y montos.</p>
        
        <div style="background:rgba(255,255,255,0.03); padding:20px; border-radius:20px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05)">
            <div class="row-2">
                <div>
                    <label style="color:var(--success)">Disponible</label>
                    <div id="stratLiquid" style="font-weight:800; font-size:1.3rem; color:var(--success)">$0.00</div>
                </div>
                <div>
                    <label style="color:var(--warning)">Colch√≥n (Reserva)</label>
                    <input type="number" id="stratBuffer" placeholder="$0" onchange="runStrategy()" step="0.01" style="padding:10px; width:100%; text-align:center; font-weight:700; background:rgba(0,0,0,0.2)">
                </div>
            </div>
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; gap:12px">
                <input type="checkbox" id="stratIncludeIncome" onchange="runStrategy()" style="width:20px; height:20px; margin:0">
                <label style="margin:0; font-size:0.85rem; cursor:pointer" for="stratIncludeIncome">Incluir Ingresos Futuros (15 d√≠as)</label>
            </div>
        </div>

        <div id="actionPlan"></div>
        
        <div id="calcResult" style="margin-top:20px; text-align:center; font-weight:800; padding:15px; border-radius:12px; background:rgba(255,255,255,0.03)"></div>
        <button class="btn btn-text" onclick="closeModal('modalStrategy')">Cerrar</button>
    </div>
</div>

<div class="modal" id="modalTx">
    <div class="sheet">
        <h3 style="margin-top:0">Nuevo Movimiento</h3>
        <div style="display:flex; gap:10px; margin-bottom:25px; background:var(--input-bg); padding:4px; border-radius:16px">
            <button class="btn" style="margin:0; padding:12px; border-radius:12px" id="btnExp" onclick="setTxMode('expense')">Gasto</button>
            <button class="btn" style="margin:0; padding:12px; border-radius:12px" id="btnInc" onclick="setTxMode('income')">Ingreso</button>
            <button class="btn" style="margin:0; padding:12px; border-radius:12px" id="btnPay" onclick="setTxMode('payment')">Transfer</button>
        </div>
        <form id="formTx">
            <input type="hidden" id="editTxId"><input type="hidden" id="txMode" value="expense">
            <div style="position:relative; margin-bottom:20px">
                <span style="position:absolute; left:20px; top:50%; transform:translateY(-50%); font-size:1.5rem; color:var(--text-muted)">$</span>
                <input type="number" id="txAmount" placeholder="0.00" step="0.01" style="font-size:2.5rem; text-align:right; padding-left:40px; font-weight:700; background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.2); border-radius:0" required>
            </div>
            <div class="input-group"><input type="text" id="txDesc" placeholder="¬øEn qu√© gastaste?" style="text-align:center; font-size:1.1rem" required></div>
            <div class="row-2">
                 <div class="input-group"><label>Fecha</label><input type="date" id="txDate" required></div>
                 <div class="input-group"><label>Categor√≠a</label><select id="txCat">
                    <option value="food">üçî Comida</option><option value="transport">‚õΩ Gas/Transp</option>
                    <option value="home">üè† Hogar</option><option value="fun">üçø Ocio</option>
                    <option value="shopping">üõçÔ∏è Compras</option><option value="health">üíä Salud</option>
                    <option value="services">üí° Servicios</option><option value="debt">üí∏ Deudas</option>
                    <option value="income">üí∞ Ingreso</option><option value="other">üì¶ Otro</option>
                </select></div>
            </div>
            <div id="divNormal" class="input-group"><label>Cuenta Afectada</label><select id="txAccount"></select></div>
            <div id="divPay" class="hidden">
                <div class="input-group"><label>Origen</label><select id="payFrom"></select></div>
                <div class="input-group"><label>Destino</label><select id="payTo"></select></div>
            </div>
            <div class="row-2" style="margin-top:20px">
                <button type="button" class="btn btn-danger hidden" id="btnDelTx" onclick="delTx()"><i class="fas fa-trash"></i></button>
                <button class="btn btn-primary" style="grid-column: span 2" id="btnSaveTx">Guardar</button>
            </div>
            <p id="txEditWarning" class="text-xs text-muted hidden" style="text-align:center; margin-top:10px">‚ö†Ô∏è Editar un movimiento NO ajusta el saldo de la cuenta. Ajusta el saldo manualmente si es necesario.</p>
            <button type="button" class="btn btn-text" onclick="closeModal('modalTx')">Cancelar</button>
        </form>
    </div>
</div>

<div class="modal" id="modalAcc">
    <div class="sheet">
        <h3 style="margin-top:0">Configurar Cuenta</h3>
        <form id="formAcc">
            <input type="hidden" id="editAccId">
            <div class="input-group"><label>Nombre</label><input type="text" id="accName" placeholder="Ej: BBVA N√≥mina" required style="font-size:1.2rem; font-weight:600"></div>
            <div class="row-2">
                <div class="input-group"><label>Tipo</label><select id="accType" onchange="toggleFields()"><option value="debit">D√©bito / Efectivo</option><option value="credit">Tarjeta de Cr√©dito</option><option value="receivable">Por Cobrar</option></select></div>
                <div class="input-group"><label>Due√±o</label><select id="accOwner"><option value="me">Personal</option><option value="partner">Pareja</option><option value="joint">Compartido</option></select></div>
            </div>
            <div class="row-2">
                <div class="input-group"><label>Saldo Actual</label><input type="number" id="accBalance" step="0.01" required></div>
                <div class="input-group"><label>L√≠mite (Cr√©dito)</label><input type="number" id="accLimit" step="0.01"></div>
            </div>
            
            <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05)">
                <label style="color:var(--info)"><i class="fas fa-lock"></i> Datos de B√≥veda</label>
                <div class="input-group" style="margin-bottom:10px"><input type="text" id="accCard" placeholder="N√∫mero Tarjeta (Solo info)"></div>
                <div class="input-group" style="margin-bottom:0"><input type="text" id="accClabe" placeholder="CLABE Interbancaria"></div>
            </div>

            <div id="fieldsCredit" class="hidden" style="background:rgba(239,68,68,0.05); padding:20px; border-radius:20px; margin-bottom:20px; border:1px solid rgba(239,68,68,0.2)">
                <label style="color:var(--danger); margin-bottom:15px"><i class="fas fa-shield-alt"></i> Datos del Centinela</label>
                <div class="row-2">
                    <div class="input-group"><label>D√≠a Corte</label><input type="number" id="accCut" placeholder="Ej: 12"></div>
                    <div class="input-group"><label>D√≠a L√≠mite Pago</label><input type="number" id="accPayDay" placeholder="Ej: 2"></div>
                </div>
                <div class="row-2">
                    <div class="input-group"><label>Pago No Intereses</label><input type="number" id="accNoInt" step="0.01"></div>
                    <div class="input-group"><label>Pago M√≠nimo</label><input type="number" id="accMin" step="0.01"></div>
                </div>
                <div class="input-group"><label>APR %</label><input type="number" id="accApr" step="0.01"></div>
            </div>
            <button class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-danger hidden" id="btnDelAcc" onclick="delAcc()" style="margin-top:10px">Eliminar</button>
            <button type="button" class="btn btn-text" onclick="closeModal('modalAcc')">Cancelar</button>
        </form>
    </div>
</div>

<div class="modal" id="modalCollect">
    <div class="sheet">
        <h3 style="color:var(--pending); margin-top:0"><i class="fas fa-hand-holding-dollar"></i> Registrar Cobro</h3>
        <p class="text-sm text-muted">Mueve saldo de "Por Cobrar" a "Efectivo".</p>
        <form id="formCollect">
            <div class="input-group"><label>Deudor</label><select id="colFrom" required></select></div>
            <div class="input-group"><label>Destino</label><select id="colTo" required></select></div>
            <div class="row-2">
                <div class="input-group"><label>Monto</label><input type="number" id="colAmount" step="0.01" required style="font-size:1.2rem; font-weight:700"></div>
                <div class="input-group"><label>Fecha</label><input type="date" id="colDate" required></div>
            </div>
            <button class="btn btn-primary" style="background:var(--success); color:black">Registrar</button>
            <button type="button" class="btn btn-text" onclick="closeModal('modalCollect')">Cancelar</button>
        </form>
    </div>
</div>

<div class="modal" id="modalPlanning">
    <div class="sheet">
        <h3 style="margin-top:0">Ingresos Futuros</h3>
        <form id="formPlan" style="margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px">
            <div class="row-2">
                <input type="text" id="planDesc" placeholder="Concepto" required>
                <input type="number" id="planAmount" placeholder="$ Monto" step="0.01" required>
            </div>
            <div class="input-group" style="margin-top:10px; display:flex; gap:10px">
                <input type="date" id="planDate" required>
                <button class="btn btn-primary" style="margin:0; width:auto"><i class="fas fa-plus"></i></button>
            </div>
        </form>
        <div id="planList" style="max-height:300px; overflow-y:auto"></div>
        <button class="btn btn-text" onclick="closeModal('modalPlanning')">Cerrar</button>
    </div>
</div>

<div class="modal" id="modalSettings">
    <div class="sheet">
        <h3 style="margin-top:0">Ajustes</h3>
        <div class="input-group">
            <label>Nombres</label>
            <div class="row-2"><input id="confMe" placeholder="Yo"><input id="confPartner" placeholder="Pareja"></div>
        </div>
        <div class="input-group">
            <label>PIN Sincronizaci√≥n (4 d√≠gitos)</label>
            <input type="password" id="confPin" maxlength="4" style="text-align:center; letter-spacing:8px; font-size:1.5rem">
        </div>
        <button class="btn btn-primary" onclick="saveSettings()">Guardar</button>
        <hr style="border-color:rgba(255,255,255,0.1); margin:25px 0">
        <button class="btn btn-danger" onclick="logout()">Cerrar Sesi√≥n</button>
        <button class="btn btn-text" onclick="closeModal('modalSettings')">Cerrar</button>
    </div>
</div>

<div class="modal" id="modalLock">
    <div class="sheet">
        <div style="text-align:center; padding:20px 0">
            <div style="width:60px; height:60px; background:rgba(255,255,255,0.05); border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-bottom:20px">
                <i class="fas fa-lock" style="font-size:1.5rem; color:var(--text-muted)"></i>
            </div>
            <h3>Acceso Protegido</h3>
            <p class="text-muted">Introduce el PIN compartido.</p>
            <input type="password" id="unlockPin" maxlength="4" style="font-size:2.5rem; text-align:center; letter-spacing:15px; margin:20px 0; background:transparent; border:none; border-bottom:2px solid var(--primary); border-radius:0; width:150px" autofocus>
            <button class="btn btn-primary" onclick="checkPin()">Desbloquear</button>
            <button class="btn btn-text" onclick="closeModal('modalLock')">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. CONFIGURACI√ìN FIREBASE
    // ==========================================
    const cfg = {
        apiKey: "AIzaSyC2Rw1f-2omvR6be9lHwbfhYT-JxyN3gmY",
        authDomain: "misfinanzas-860a5.firebaseapp.com",
        projectId: "misfinanzas-860a5",
        storageBucket: "misfinanzas-860a5.firebasestorage.app",
        messagingSenderId: "472835658078",
        appId: "1:472835658078:web:b4224d8a35b4091cafffcf"
    };

    if(!firebase.apps.length) firebase.initializeApp(cfg);
    const auth = firebase.auth(); 
    const db = firebase.firestore();

    // Estado Global
    const state = { 
        user: null, accounts: [], txs: [], planning: [], 
        filter: 'me', typeFilter: 'all', 
        syncUnlocked: false, privacy: false,
        settings: JSON.parse(localStorage.getItem('sf_conf')) || { pin: '0000', me:'M√≠o', partner:'Pareja' },
        buffer: parseFloat(localStorage.getItem('sf_buffer')) || 0
    };

    // ==========================================
    // 2. UTILIDADES DOM MEJORADAS
    // ==========================================
    const $ = (i) => document.getElementById(i);
    const val = (i) => $(i).value;
    
    // Convierte input a float seguro
    const num = (i) => {
        const v = $(i).value;
        return (v === '' || isNaN(v)) ? 0 : parseFloat(parseFloat(v).toFixed(2));
    };
    
    // Formato moneda MXN
    const fmt = (n) => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n||0);
    
    // Loading Spinner
    const loading = (a) => $('loading-overlay').classList.toggle('active', a);
    
    // Toast Notification System
    const showToast = (msg, type = 'info') => {
        const c = $('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle')}"></i> <span>${msg}</span>`;
        c.appendChild(t);
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 300);
        }, 3000);
    };

    // Modales
    const openModal = (i) => { $(i).classList.add('open'); };
    const closeModal = (i) => { $(i).classList.remove('open'); };
    document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('click', (e) => { if(e.target === m) closeModal(m.id); });
    });

    // ==========================================
    // 3. AUTH & INIT
    // ==========================================
    auth.onAuthStateChanged(u => {
        if(u) {
            state.user = u;
            $('auth-screen').style.display='none'; 
            $('app-screen').style.display='block';
            setTimeout(()=>$('app-screen').classList.add('loaded'), 100);
            
            $('uName').innerText = u.displayName ? u.displayName.split(' ')[0] : 'Usuario';
            $('dateFilter').value = new Date().toISOString().slice(0,7);
            
            $('stratBuffer').value = state.buffer;
            $('confMe').value = state.settings.me;
            $('confPartner').value = state.settings.partner;
            $('confPin').value = state.settings.pin;
            updateLabels();
            
            loadData();
        } else {
            $('auth-screen').style.display='flex'; 
            $('app-screen').style.display='none';
        }
    });

    window.login = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast("Error Auth: "+e.message, 'error'));
    window.logout = () => auth.signOut();

    // ==========================================
    // 4. DATA LOGIC
    // ==========================================
    function loadData() {
        loading(true);
        db.collection('accounts').onSnapshot(s => {
            state.accounts = [];
            s.forEach(d => {
                const da = d.data();
                state.accounts.push({
                    id: d.id, ...da,
                    // Asegurar floats
                    balance: parseFloat(da.balance)||0, limit: parseFloat(da.limit)||0,
                    apr: parseFloat(da.apr)||0, cut: parseInt(da.cut)||0, payDay: parseInt(da.payDay)||0,
                    noInt: parseFloat(da.noInt)||0, min: parseFloat(da.min)||0,
                    card: da.card || '', clabe: da.clabe || ''
                });
            });
            renderAccounts();
            loading(false);
        }, error => {
            console.error(error);
            loading(false);
        });
        
        db.collection('planning').onSnapshot(s => {
            state.planning = [];
            s.forEach(d => state.planning.push({id:d.id, ...d.data()}));
            renderPlanning();
            renderAccounts(); // Actualizar dashboard
        });
        
        loadTransactions();
    }

    // ==========================================
    // 5. RENDERIZADO
    // ==========================================
    function renderAccounts() {
        const l = $('accList'); l.innerHTML = '';
        let assets=0, debt=0, pending=0;
        
        const visible = state.accounts.filter(a => {
            let ownerMatch = false;
            if(state.filter === 'me') ownerMatch = (a.owner === 'me' || a.owner === 'joint');
            else if(state.filter === 'partner' && state.syncUnlocked) ownerMatch = (a.owner === 'partner' || a.owner === 'joint');
            else if(state.filter === 'all' && state.syncUnlocked) ownerMatch = true;

            let typeMatch = true;
            if(state.typeFilter === 'debit') typeMatch = (a.type === 'debit');
            else if(state.typeFilter === 'credit') typeMatch = (a.type === 'credit' || a.type === 'receivable');

            return ownerMatch && typeMatch;
        });

        // Totales Globales
        state.accounts.forEach(a => {
            let isVisibleUser = false;
            if(state.filter === 'me') isVisibleUser = (a.owner === 'me' || a.owner === 'joint');
            else if(state.filter === 'partner' && state.syncUnlocked) isVisibleUser = (a.owner === 'partner' || a.owner === 'joint');
            else if(state.filter === 'all' && state.syncUnlocked) isVisibleUser = true;

            if(isVisibleUser) {
                if(a.type==='credit') debt += a.balance;
                else if(a.type==='receivable') pending += a.balance;
                else assets += a.balance;
            }
        });

        $('assetDisplay').innerText = fmt(assets);
        $('debtDisplay').innerText = fmt(debt);
        $('pendDisplay').innerText = fmt(pending);
        $('netDisplay').innerText = fmt(assets - debt);
        
        const today = new Date(); const limit = new Date(); limit.setDate(today.getDate()+15);
        const nextInc = state.planning.filter(p=>new Date(p.date)>=today && new Date(p.date)<=limit).reduce((s,p)=>s+parseFloat(p.amount),0);
        $('goalsDisplay').innerText = "+" + fmt(nextInc);
        
        document.querySelectorAll('.net-val, .stat-item span:last-child').forEach(el => el.classList.toggle('blur-text', state.privacy));

        if(visible.length === 0) l.innerHTML = '<div style="text-align:center;width:100%;color:var(--text-muted);padding:40px;border:2px dashed rgba(255,255,255,0.05);border-radius:20px;">Sin cuentas en esta vista</div>';

        visible.sort((a,b) => (a.order||0) - (b.order||0)).forEach(a => {
            const card = document.createElement('div'); card.className = 'bank-card';
            card.style.background = `linear-gradient(135deg, ${getBankColor(a.name)}, #10141d)`;
            card.onclick = (e) => { if(!e.target.closest('.sentinel-alert')) openEditAcc(a); };
            
            let extra = '';
            let sentinelBadge = '';
            let ownerBadge = '';

            // Badge de Due√±o (solo si es mancomunado o viendo todo)
            if(a.owner === 'joint') ownerBadge = `<div class="owner-badge joint">COMPARTIDA</div>`;
            else if(state.filter === 'all') ownerBadge = `<div class="owner-badge">${a.owner === 'me' ? state.settings.me : state.settings.partner}</div>`;

            if(a.type==='credit') {
                if(a.limit > 0) {
                    const p = Math.min(100, (a.balance/a.limit)*100);
                    extra += `<div style="height:6px;background:rgba(255,255,255,0.1);margin-top:10px;border-radius:3px;overflow:hidden"><div style="width:${p}%;background:${p>70?'var(--danger)':'var(--success)'};height:100%"></div></div>`;
                }
                
                if(a.noInt > 0 || a.min > 0) {
                     extra += `<div class="card-data-row">
                        <span>P. No Int: <b style="color:white">${fmt(a.noInt)}</b></span>
                        <span>Min: <b style="color:white">${fmt(a.min)}</b></span>
                     </div>`;
                }

                if(a.payDay) {
                    const t = new Date().getDate();
                    let diff = a.payDay - t;
                    if(diff < 0) diff += 30;
                    if(diff <= 5 && a.balance > 0) sentinelBadge = `<div class="sentinel-alert danger"><i class="fas fa-exclamation-triangle"></i> PAGA EN ${diff} D√çAS</div>`;
                    else if (diff <= 10 && a.balance > 0) sentinelBadge = `<div class="sentinel-alert warning">Faltan ${diff} d√≠as</div>`;
                }
            }

            let balDisplay = fmt(a.balance);
            if(state.privacy) balDisplay = '****';
            const icon = a.type==='credit' ? 'fa-credit-card' : (a.type==='receivable'?'fa-hand-holding-dollar':'fa-wallet');

            card.innerHTML = `
                ${sentinelBadge}
                ${ownerBadge}
                <div>
                    <div class="flex-between">
                        <i class="fas ${icon}" style="opacity:0.5"></i>
                    </div>
                    <div class="font-bold" style="margin-top:12px; font-size:1.1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${a.name}</div>
                </div>
                <div>
                    <div style="font-size:1.6rem;font-weight:800;letter-spacing:-0.5px">${balDisplay}</div>
                    ${extra}
                </div>
            `;
            l.appendChild(card);
        });
        
        runBrain(assets, debt);
    }

    // ==========================================
    // 6. LOGICA CEREBRO Y FILTROS
    // ==========================================
    window.setTypeFilter = (t) => {
        state.typeFilter = t;
        ['ft-all','ft-debit','ft-credit'].forEach(id => $(id).classList.remove('active'));
        $(`ft-${t}`).classList.add('active');
        renderAccounts();
    };

    function runBrain(assets, debt) {
        const msg = $('brain-msg'); const badge = $('brain-badge');
        if (debt > assets && debt > 0) {
            msg.innerHTML = `‚ö†Ô∏è <b>CR√çTICO:</b> Pasivos superan activos.`;
            msg.style.color = "#fca5a5"; badge.innerText = "PELIGRO"; badge.style.background = "var(--danger)";
        } else if (debt > 0) {
            msg.innerHTML = `Centinela activo. Fechas de corte monitoreadas.`;
            msg.style.color = "white"; badge.innerText = "OPTIMIZAR"; badge.style.background = "var(--warning)";
        } else {
            msg.innerHTML = `‚úÖ <b>SALUDABLE:</b> Liquidez total.`;
            msg.style.color = "#86efac"; badge.innerText = "ESTABLE"; badge.style.background = "var(--success)";
        }
    }

    window.runStrategy = () => {
        const buffer = num('stratBuffer');
        state.buffer = buffer; localStorage.setItem('sf_buffer', buffer);
        
        const visible = state.accounts.filter(a => {
            if(state.filter === 'me') return a.owner === 'me' || a.owner === 'joint';
            if(state.syncUnlocked) return true; 
            return false;
        });
        
        let liquid = visible.reduce((s,a) => (a.type==='debit' ? s+a.balance : s), 0);
        if($('stratIncludeIncome').checked) {
            const t = new Date(); const l = new Date(); l.setDate(t.getDate() + 15);
            liquid += state.planning.filter(p => new Date(p.date) >= t && new Date(p.date) <= l).reduce((s,p) => s + (parseFloat(p.amount)||0), 0);
        }
        $('stratLiquid').innerText = fmt(liquid);

        const debts = visible.filter(a => a.type==='credit' && a.balance > 0);
        const container = $('actionPlan');
        let html = ''; let totalToPay = 0; const today = new Date().getDate();

        if (debts.length > 0) {
            debts.sort((a,b) => {
                const diffA = (a.payDay||30) - today; const diffB = (b.payDay||30) - today;
                const urgA = (diffA <= 5 && diffA >= -5) ? 1000 : 0;
                const urgB = (diffB <= 5 && diffB >= -5) ? 1000 : 0;
                return (urgB + (b.apr||0)) - (urgA + (a.apr||0));
            });
            let available = liquid - buffer;
            if (available < 0) html += `<div class="strat-card urgent"><strong>üö® EMERGENCIA</strong><p class="text-sm">No cubres tu reserva.</p></div>`;
            debts.forEach(d => {
                const diff = (d.payDay||30) - today;
                const isUrgent = (diff <= 5 && diff >= -5);
                let pay = 0; let reason = ""; let color = "";
                if (isUrgent) {
                    if (available >= (d.noInt || d.balance)) { pay = d.noInt || d.balance; reason = "üî• ¬°Vence ya!"; color = "var(--primary)"; } 
                    else { pay = d.min || (d.balance * 0.10); reason = "‚ö†Ô∏è M√≠nimo."; color = "var(--warning)"; }
                } else {
                    if (available > d.balance) { pay = d.balance; reason = "Liquidar"; color = "var(--success)"; } 
                    else { pay = 0; reason = `Vence d√≠a ${d.payDay}.`; color = "var(--text-muted)"; }
                }
                if(pay > 0) { available -= pay; totalToPay += pay; }
                html += `<div class="strat-card" style="border-left:4px solid ${color}; display:flex; justify-content:space-between; align-items:center" onclick="execStrat('${d.id}', '${d.name}', ${pay})"><div><div class="font-bold">${d.name}</div><div class="text-xs text-muted" style="margin-top:4px">${reason}</div></div><div style="text-align:right"><div class="font-bold" style="font-size:1.1rem">-${fmt(pay)}</div><div class="text-xs" style="color:${color}; font-weight:700">PAGAR</div></div></div>`;
            });
        } else {
            html += `<div class="strat-card ok"><strong>üöÄ LIBRE DE DEUDAS</strong></div>`;
        }
        container.innerHTML = html;
        const final = liquid - buffer - totalToPay;
        $('calcResult').innerText = final >= 0 ? `Restante: ${fmt(final)}` : `D√©ficit: ${fmt(final)}`;
        $('calcResult').style.color = final >= 0 ? 'var(--success)' : 'var(--danger)';
    };

    window.execStrat = (id, name, amt) => {
        if(amt <= 0) return;
        openTxModal(); setTxMode('payment'); $('payTo').value = id; 
        $('txAmount').value = amt.toFixed(2); $('txDesc').value = `Pago: ${name}`;
        const srcs = state.accounts.filter(a => a.type === 'debit' && a.balance >= amt);
        if(srcs.length > 0) $('payFrom').value = srcs[0].id;
        closeModal('modalStrategy');
    };
    window.openStrategyModal = () => { openModal('modalStrategy'); runStrategy(); };

    // ==========================================
    // 7. TRANSACCIONES
    // ==========================================
    function loadTransactions() {
        const m = $('dateFilter').value; if(!m) return;
        const start = m + "-01"; 
        const d = new Date(m+"-01"); d.setMonth(d.getMonth()+1); d.setDate(0); const end = m + "-" + d.getDate();
        
        db.collection('transactions').where('date','>=',start).where('date','<=',end).orderBy('date','desc').limit(50).onSnapshot(s => {
            const l = $('txList'); l.innerHTML = ''; state.txs = [];
            s.forEach(d => state.txs.push({id:d.id, ...d.data()}));
            
            const visible = state.txs.filter(t => {
                const accId = t.accId || t.fromId; 
                const acc = state.accounts.find(a => a.id === accId);
                if(!acc) return true; 
                if(state.filter === 'me') return acc.owner === 'me' || acc.owner === 'joint';
                if(state.filter === 'partner' && state.syncUnlocked) return acc.owner === 'partner' || acc.owner === 'joint';
                if(state.filter === 'all' && state.syncUnlocked) return true;
                return false;
            });

            if(visible.length === 0) l.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Sin movimientos</div>';

            visible.forEach(t => {
                let color='var(--text)', icon='fa-circle';
                if(t.type==='expense'){ color='var(--danger)'; icon='fa-arrow-trend-down'; }
                if(t.type==='income'){ color='var(--success)'; icon='fa-arrow-trend-up'; }
                if(t.type==='transfer'){ color='var(--info)'; icon='fa-exchange-alt'; }

                const div = document.createElement('div'); div.className = 'tx-item';
                div.onclick = () => openEditTx(t);
                let amountDisplay = fmt(t.amount); if(state.privacy) amountDisplay = '****';

                div.innerHTML = `<div style="display:flex;align-items:center"><div class="tx-icon" style="color:${color}"><i class="fas ${icon}"></i></div><div><div class="font-bold">${t.desc}</div><small class="text-muted">${t.date} ‚Ä¢ ${getCatIcon(t.cat)}</small></div></div><div class="font-bold" style="color:${color}">${amountDisplay}</div>`;
                l.appendChild(div);
            });
        });
    }

    // ==========================================
    // 8. CRUD
    // ==========================================
    $('formAcc').onsubmit = async (e) => {
        e.preventDefault(); loading(true);
        const d = { 
            name: val('accName'), type: val('accType'), balance: num('accBalance'), limit: num('accLimit'), owner: val('accOwner'),
            cut: num('accCut'), payDay: num('accPayDay'), noInt: num('accNoInt'), min: num('accMin'), apr: num('accApr'),
            card: val('accCard'), clabe: val('accClabe')
        };
        const id = val('editAccId');
        try {
            if(id) { await db.collection('accounts').doc(id).update(d); showToast('Cuenta actualizada', 'success'); }
            else { await db.collection('accounts').add(d); showToast('Cuenta creada', 'success'); }
            closeModal('modalAcc');
        } catch(err) { showToast(err.message, 'error'); }
        loading(false);
    };

    $('btnSaveTx').onclick = async () => {
        const form = $('formTx'); if(!form.checkValidity()) { form.reportValidity(); return; }
        loading(true); const id = val('editTxId');
        const d = { amount: num('txAmount'), desc: val('txDesc'), date: val('txDate'), type: val('txMode'), cat: val('txCat'), accId: val('txAccount')||null, fromId: val('payFrom')||null, toId: val('payTo')||null };
        
        try {
            const batch = db.batch(); const ref = id ? db.collection('transactions').doc(id) : db.collection('transactions').doc();
            
            // SOLO actualizamos balance si es NUEVO. Si es EDITAR, no tocamos balances para evitar desyncs complejos
            if(!id) { 
                if(d.type==='expense'){ 
                    const a=state.accounts.find(x=>x.id===d.accId); 
                    if(a) {
                        let nb=a.balance; 
                        if(a.type==='credit') nb = (parseFloat(nb) + parseFloat(d.amount));
                        else nb = (parseFloat(nb) - parseFloat(d.amount)); 
                        batch.update(db.collection('accounts').doc(a.id),{balance:nb});
                    }
                } 
                else if(d.type==='income'){ 
                    const a=state.accounts.find(x=>x.id===d.accId); 
                    if(a) {
                        let nb=a.balance; 
                        if(a.type==='credit') nb = (parseFloat(nb) - parseFloat(d.amount));
                        else nb = (parseFloat(nb) + parseFloat(d.amount)); 
                        batch.update(db.collection('accounts').doc(a.id),{balance:nb}); 
                    }
                } 
                else if(d.type==='payment'){ 
                    const f=state.accounts.find(x=>x.id===d.fromId); 
                    const t=state.accounts.find(x=>x.id===d.toId); 
                    if(f && t) {
                        batch.update(db.collection('accounts').doc(f.id),{balance: parseFloat(f.balance)-parseFloat(d.amount)}); 
                        let tb=t.balance; 
                        if(t.type==='credit') tb = (parseFloat(tb) - parseFloat(d.amount));
                        else tb = (parseFloat(tb) + parseFloat(d.amount)); 
                        batch.update(db.collection('accounts').doc(t.id),{balance:tb}); 
                    }
                }
            }
            batch.set(ref,d); await batch.commit(); 
            showToast(id ? 'Movimiento actualizado' : 'Movimiento guardado', 'success');
            closeModal('modalTx');
        } catch(err) { showToast(err.message, 'error'); }
        loading(false); 
    };

    window.openCollectModal = () => {
        const fs=$('colFrom'); fs.innerHTML=''; const ts=$('colTo'); ts.innerHTML='';
        state.accounts.filter(a=>a.type==='receivable').forEach(a=>fs.innerHTML+=`<option value="${a.id}">${a.name}</option>`);
        state.accounts.filter(a=>a.type==='debit').forEach(a=>ts.innerHTML+=`<option value="${a.id}">${a.name}</option>`);
        if(fs.children.length===0) return showToast("Crea una cuenta 'Por Cobrar'", 'error');
        if(ts.children.length===0) return showToast("Necesitas una cuenta de D√©bito", 'error');
        $('colDate').valueAsDate = new Date(); openModal('modalCollect');
    };
    $('formCollect').onsubmit = async (e) => {
        e.preventDefault(); loading(true); const amt=num('colAmount'); const f=val('colFrom'); const t=val('colTo');
        try {
            const batch = db.batch(); 
            const fa = state.accounts.find(a=>a.id===f); batch.update(db.collection('accounts').doc(f),{balance:fa.balance-amt});
            const ta = state.accounts.find(a=>a.id===t); batch.update(db.collection('accounts').doc(t),{balance:ta.balance+amt});
            const r = db.collection('transactions').doc();
            batch.set(r, {amount:amt, date:val('colDate'), desc:`Cobro: ${fa.name}`, type:'transfer', fromId:f, toId:t, cat:'income'});
            await batch.commit(); 
            showToast('Cobro registrado exitosamente', 'success');
            closeModal('modalCollect');
        } catch(err) { showToast(err.message, 'error'); }
        loading(false); 
    };

    // Planning
    function renderPlanning() {
        const l = $('planList'); l.innerHTML = '';
        state.planning.sort((a,b)=>a.date.localeCompare(b.date)).forEach(p => {
            const div = document.createElement('div');
            div.style.cssText = "display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,0.05);align-items:center";
            div.innerHTML = `<div><div class="font-bold">${p.desc}</div><small class="text-muted"><i class="far fa-clock"></i> ${p.date}</small></div><div class="font-bold" style="color:var(--success)">+${fmt(p.amount)} <i class="fas fa-times" style="margin-left:12px;color:var(--text-muted);cursor:pointer;font-size:0.9rem" onclick="delPlan('${p.id}')"></i></div>`;
            l.appendChild(div);
        });
    }
    $('formPlan').onsubmit = async (e) => { e.preventDefault(); await db.collection('planning').add({desc:val('planDesc'), amount:num('planAmount'), date:val('planDate')}); $('formPlan').reset(); showToast('Ingreso planificado','success'); };
    window.delPlan = (id) => { if(confirm('¬øBorrar?')) db.collection('planning').doc(id).delete(); };

    // ==========================================
    // 9. UI HELPERS
    // ==========================================
    window.openTxModal = () => { 
        $('editTxId').value=''; 
        $('btnDelTx').classList.add('hidden'); 
        $('txEditWarning').classList.add('hidden');
        $('txDate').valueAsDate=new Date(); // Setea fecha local correctamente
        $('txDesc').value=''; 
        $('txAmount').value=''; 
        setTxMode('expense'); 
        openModal('modalTx'); 
    };
    
    window.openEditTx = (t) => { 
        $('editTxId').value=t.id; 
        $('btnDelTx').classList.remove('hidden'); 
        $('txEditWarning').classList.remove('hidden'); // Advertencia de no-balance update
        $('txAmount').value=t.amount; 
        $('txDesc').value=t.desc; 
        $('txDate').value=t.date; 
        $('txCat').value=t.cat; 
        setTxMode(t.type==='transfer'?'payment':t.type); 
        if(t.type==='transfer'){$('payFrom').value=t.fromId;$('payTo').value=t.toId}else{$('txAccount').value=t.accId}; 
        openModal('modalTx'); 
    };
    
    window.openAccModal = () => { $('formAcc').reset(); $('editAccId').value=''; $('btnDelAcc').classList.add('hidden'); toggleFields(); openModal('modalAcc'); };
    
    window.openEditAcc = (a) => { 
        $('editAccId').value=a.id; 
        $('btnDelAcc').classList.remove('hidden'); 
        $('accName').value=a.name; 
        $('accType').value=a.type; 
        $('accBalance').value=a.balance; 
        $('accOwner').value=a.owner; 
        $('accLimit').value = a.limit || '';
        $('accCut').value = a.cut || ''; 
        $('accPayDay').value = a.payDay || ''; 
        $('accNoInt').value = a.noInt || ''; 
        $('accMin').value = a.min || ''; 
        $('accApr').value = a.apr || ''; 
        $('accCard').value = a.card || ''; 
        $('accClabe').value = a.clabe || ''; 
        toggleFields(); 
        openModal('modalAcc'); 
    };
    
    window.setTxMode = (m) => { 
        $('txMode').value=m; 
        $('divPay').classList.toggle('hidden',m!=='payment'); 
        $('divNormal').classList.toggle('hidden',m==='payment'); 
        const s=(id)=>{$(id).innerHTML='';state.accounts.forEach(a=>$(id).innerHTML+=`<option value="${a.id}">${a.name} (${fmt(a.balance)})</option>`)}; 
        s('txAccount');s('payFrom');s('payTo'); 
        ['btnExp','btnInc','btnPay'].forEach(b=> { $(b).className='btn'; $(b).style.background='transparent'; $(b).style.color='var(--text-muted)'; });
        const active = m==='expense'?'btnExp':(m==='income'?'btnInc':'btnPay');
        const color = m==='expense'?'var(--danger)':(m==='income'?'var(--success)':'var(--info)');
        $(active).style.background = color; $(active).style.color = 'white'; $(active).style.boxShadow = `0 4px 15px ${color}40`;
    };
    
    window.toggleFields = () => { const t=val('accType'); $('fieldsCredit').classList.toggle('hidden', t!=='credit'); };
    window.delAcc = async () => { if(confirm("¬øBorrar cuenta?")) { await db.collection('accounts').doc(val('editAccId')).delete(); closeModal('modalAcc'); showToast('Cuenta eliminada', 'success'); }};
    window.delTx = async () => { if(confirm("¬øBorrar movimiento?")) { await db.collection('transactions').doc(val('editTxId')).delete(); closeModal('modalTx'); showToast('Movimiento eliminado', 'success'); }};

    window.togglePrivacy = () => { state.privacy = !state.privacy; $('privacy-label').innerText = state.privacy ? "Oculto" : "Visible"; $('privacy-toggle').classList.toggle('active', state.privacy); renderAccounts(); loadTransactions(); };
    window.unlockSync = (target) => { if(state.syncUnlocked) setFilter(target); else { window.pendingFilter = target; openModal('modalLock'); } };
    window.checkPin = () => { if(val('unlockPin') === state.settings.pin) { state.syncUnlocked = true; closeModal('modalLock'); setFilter(window.pendingFilter); $('tabPartner').classList.remove('locked'); $('tabAll').classList.remove('locked'); showToast('Acceso desbloqueado', 'success'); } else { showToast('PIN Incorrecto', 'error'); $('unlockPin').value = ''; } };
    window.setFilter = (f) => { state.filter = f; ['tabMe','tabPartner','tabAll'].forEach(t => $(t).className = 'tab-btn'); if(f==='me') $('tabMe').classList.add('active'); if(f==='partner') { $('tabPartner').classList.add('active'); $('tabPartner').classList.remove('locked'); } if(f==='all') { $('tabAll').classList.add('active'); $('tabAll').classList.remove('locked'); } renderAccounts(); loadTransactions(); };
    window.saveSettings = () => { state.settings.me=val('confMe'); state.settings.partner=val('confPartner'); state.settings.pin=val('confPin'); localStorage.setItem('sf_conf', JSON.stringify(state.settings)); updateLabels(); closeModal('modalSettings'); showToast('Ajustes guardados', 'success'); };
    window.updateLabels = () => { $('tabMe').innerText=state.settings.me; $('tabPartner').innerText=state.settings.partner; const s=$('accOwner'); if(s){s.options[0].text=state.settings.me; s.options[1].text=state.settings.partner;} $('uName').innerText = state.user ? (state.user.displayName || 'Usuario') : 'Usuario'; };
    window.getBankColor = (n) => { n=n.toLowerCase(); if(n.includes('bbva'))return '#004481'; if(n.includes('nu'))return '#820ad1'; if(n.includes('santander'))return '#ec0000'; if(n.includes('amex'))return '#006fcf'; if(n.includes('banamex'))return '#003865'; if(n.includes('hsbc'))return '#db0011'; return '#1e293b'; };
    window.getCatIcon = (c) => { const map = { food:'üçî', transport:'‚õΩ', home:'üè†', fun:'üçø', shopping:'üõçÔ∏è', health:'üíä', services:'üí°', debt:'üí∏', income:'üí∞', other:'üì¶' }; return map[c] || 'üìÑ'; };
</script>
</body>
</html>