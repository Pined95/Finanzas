<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFinance | Titanium v60 (Partner Sync)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* === ARQUITECTURA VISUAL (TITANIUM DESIGN SYSTEM) === */
        :root { 
            --bg: #0b0f19; --card: #151b2b; --input: #232936;
            --text: #ffffff; --text-muted: #94a3b8; 
            --primary: #6366f1; --accent: #8b5cf6;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --info: #0ea5e9; --pending: #fbbf24;
            --card-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 140px; overflow-x: hidden; user-select: none; min-height: 100vh; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 20px; display: none; opacity: 0; transition: opacity 0.5s ease; }
        .container.loaded { opacity: 1; }
        
        /* PANTALLA DE CARGA Y ERRORES */
        #auth-screen { display: block; text-align: center; padding-top: 30vh; animation: fadeIn 0.5s; }
        #loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 900; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        #loading-overlay.active { opacity: 1; pointer-events: all; }
        .loader { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        
        #error-bar { position: fixed; top: 0; left: 0; right: 0; background: var(--danger); color: white; padding: 12px; font-size: 0.8rem; text-align: center; display: none; z-index: 9999; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 12px; background: rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); font-size: 1.2rem; transition: transform 0.1s; position: relative; }
        .icon-btn:active { transform: scale(0.95); }
        .privacy-toggle { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; background: rgba(255,255,255,0.1); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .privacy-toggle.active { background: var(--primary); color: white; }

        /* TABS */
        .profile-tabs { background: rgba(0,0,0,0.3); padding: 5px; border-radius: 16px; display: flex; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .pt-btn { flex: 1; text-align: center; padding: 12px; border-radius: 12px; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .pt-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }

        /* CARDS PRINCIPALES */
        .summary-card { background: linear-gradient(160deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; padding: 25px; margin-bottom: 20px; position: relative; box-shadow: var(--card-shadow); overflow: hidden; }
        .net-val { font-size: 2.8rem; font-weight: 800; margin: 5px 0; color: white; letter-spacing: -1px; transition: filter 0.3s; }
        .net-val.blur { filter: blur(8px); user-select: none; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .stat-item span:first-child { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        .stat-item span:last-child { font-weight: 700; font-size: 1.1rem; color: white; }
        .tax-card { border-left: 4px solid var(--warning); cursor: pointer; transition: transform 0.2s; }
        .tax-card:active { transform: scale(0.98); }

        /* LISTA CUENTAS */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin: 35px 0 15px; }
        .section-title { font-weight: 800; color: var(--text-muted); font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; }

        .acc-list { display: flex; overflow-x: auto; gap: 15px; padding: 5px 5px 25px; scroll-snap-type: x mandatory; }
        .acc-list::-webkit-scrollbar { display: none; }
        .bank-card { 
            flex: 0 0 290px; min-height: 190px; 
            background: #1e293b; border-radius: 22px; padding: 25px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            scroll-snap-align: center; border: 1px solid rgba(255,255,255,0.05); 
            box-shadow: var(--card-shadow); position: relative; cursor: pointer;
            transition: transform 0.2s;
        }
        .bank-card:active { transform: scale(0.97); }
        .badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); }
        .credit-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .credit-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
        .cut-info { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; font-family: monospace; }
        
        /* DATA EMPTY STATE */
        .empty-state { text-align: center; padding: 30px 20px; color: var(--text-muted); background: rgba(255,255,255,0.02); border-radius: 16px; border: 1px dashed rgba(255,255,255,0.1); margin: 10px 0; font-size: 0.9rem; }
        .filter-chip { display: inline-flex; align-items: center; gap: 8px; background: rgba(99,102,241,0.2); color: var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-left: 10px; cursor: pointer; border: 1px solid rgba(99,102,241,0.3); }

        /* LISTA HISTORIAL */
        .tx-list { display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .tx-item { background: var(--card-bg); padding: 16px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.03); cursor: pointer; transition: background 0.2s; }
        .tx-item:active { background: rgba(255,255,255,0.05); }
        .tx-icon { width: 44px; height: 44px; background: rgba(255,255,255,0.05); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; }

        /* MODALES */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        .modal.open { display: flex; opacity: 1; }
        .sheet { background: #11141d; width: 100%; max-width: 550px; border-radius: 32px 32px 0 0; padding: 30px; max-height: 90vh; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.15); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal.open .sheet { transform: translateY(0); }

        /* FORMULARIOS */
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 16px; background: var(--input); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; color: white; font-size: 1rem; outline: none; transition: 0.2s; -webkit-appearance: none; }
        input:focus, select:focus { border-color: var(--primary); background: #1a1e29; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: transform 0.1s, box-shadow 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3); }
        .btn-text { background: transparent; color: var(--text-muted); margin-top: 5px; }
        .fab { position: fixed; bottom: 35px; right: 25px; width: 65px; height: 65px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5); z-index: 100; border: 2px solid rgba(255,255,255,0.1); transition: transform 0.2s; cursor: pointer; }
        .fab:hover { transform: scale(1.05); }

        /* EXTRAS */
        .bank-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .bank-chip { padding: 12px; border-radius: 12px; font-size: 0.7rem; text-align: center; cursor: pointer; background: var(--input); border: 1px solid transparent; font-weight: 600; transition: 0.2s; }
        .bank-chip.selected { border-color: var(--primary); background: rgba(99,102,241,0.2); color: white; }

        .toggle-switch { position: relative; width: 46px; height: 26px; display: inline-block; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #334155; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        .plan-step { background: rgba(255,255,255,0.03); border-left: 4px solid var(--text-muted); padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .plan-step.urgent { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
        
        .goal-item { background: var(--card-bg); padding: 15px; border-radius: 16px; margin-bottom: 10px; border-left: 4px solid var(--info); display: flex; justify-content: space-between; align-items: center; }
        .goal-progress { width: 100%; height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 8px; }
        .goal-fill { height: 100%; background: var(--info); border-radius: 3px; }
        
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; }
        .detail-copy-box { background: rgba(0,0,0,0.3); border: 1px dashed rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 10px; font-family: monospace; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: var(--info); }
        .detail-copy-box:active { background: rgba(99,102,241,0.1); }
        
        /* SECURITY BLUR */
        .secure-reveal { filter: blur(4px); transition: filter 0.2s; cursor: pointer; }
        .secure-reveal.visible { filter: none; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="error-bar"></div>
<div id="loading-overlay"><div class="loader"></div><div style="margin-top:10px;font-size:0.8rem;color:var(--text-muted)">Sincronizando...</div></div>

<script>
    window.onerror = function(msg, url, line) {
        const bar = document.getElementById('error-bar');
        bar.style.display = 'block';
        bar.innerText = `Error: ${msg} (L√≠nea: ${line})`;
        console.error(msg);
        setTimeout(() => bar.style.display = 'none', 5000);
    };
</script>

<div id="auth-screen">
    <div style="text-align:center; padding-top: 35vh;">
        <i class="fas fa-wallet" style="font-size: 5rem; color: var(--primary); margin-bottom: 25px;"></i>
        <h1>SmartFinance</h1>
        <p style="color:var(--text-muted); margin-bottom:40px">Titanium v60 (Partner Sync)</p>
        <button class="btn btn-primary" style="max-width:280px" onclick="login()">
            <i class="fab fa-google" style="margin-right:10px"></i> Entrar con Google
        </button>
    </div>
</div>

<div class="container" id="app-screen">
    
    <div class="header">
        <div>
            <div style="display:flex; gap:10px; align-items:center">
                <small style="color:var(--text-muted); font-weight:700">HOLA,</small>
                <div class="privacy-toggle" id="privacyBtn" onclick="togglePrivacy()">
                    <i class="fas fa-eye"></i> <span id="privacyText">Visible</span>
                </div>
            </div>
            <h3 id="uName" style="margin:5px 0 0; font-size:1.5rem">...</h3>
        </div>
        <div style="display:flex; gap:10px">
            <div class="icon-btn" onclick="openChartModal()"><i class="fas fa-chart-pie"></i></div>
            <div class="icon-btn" onclick="openModal('modalSettings')"><i class="fas fa-cog"></i></div>
        </div>
    </div>

    <div class="profile-tabs">
        <div class="pt-btn active" id="tabAll" onclick="setFilter('all')">Todo</div>
        <div class="pt-btn" id="tabMe" onclick="setFilter('me')">M√≠o</div>
        <div class="pt-btn" id="tabPartner" onclick="setFilter('partner')">Pareja</div>
    </div>

    <div id="advisor" class="advisor-box">
        <div class="ai-title"><i class="fas fa-robot"></i> ESTRATEGIA</div>
        <div id="advisor-content" style="margin-bottom:15px; font-size:0.95rem; line-height:1.5; opacity:0.9"></div>
        <div class="ai-actions">
            <button class="ai-btn" onclick="openStrategyModal()"><i class="fas fa-calculator"></i> Planificar</button>
            <button class="ai-btn" onclick="openRecModal()" style="background:rgba(255,255,255,0.1)"><i class="fas fa-sync"></i> Fijos</button>
        </div>
    </div>

    <div class="summary-card">
        <div class="net-title">Patrimonio Real</div>
        <div class="net-val" id="netDisplay">$0.00</div>
        <small style="color:var(--text-muted)">Disponible: <span id="liqDisplay" style="color:var(--success); font-weight:700">$0.00</span></small>
        <div class="stat-grid">
            <div class="stat-item"><span>Deuda</span><span class="stat-val" style="color:var(--danger); font-weight:700" id="debtDisplay">--</span></div>
            <div class="stat-item"><span>Activos</span><span class="stat-val" style="color:var(--success); font-weight:700" id="assetDisplay">--</span></div>
            <div class="stat-item"><span>Metas</span><span class="stat-val" style="color:var(--info); font-weight:700" id="goalsDisplay">--</span></div>
            <div class="stat-item"><span>Por Cobrar</span><span class="stat-val" style="color:var(--pending); font-weight:700" id="pendDisplay">--</span></div>
        </div>
    </div>

    <div class="summary-card tax-card" style="padding:15px" onclick="openTaxModal()">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
                <div class="net-title" style="color:var(--warning)">Fiscal (IVA)</div>
                <div style="font-size:1.4rem; font-weight:800; margin-top:5px" id="taxPayable">$0.00</div>
                <small style="color:var(--text-muted); font-size:0.75rem">A Pagar Estimado</small>
            </div>
            <div style="text-align:right; font-size:0.85rem; color:var(--text-muted)">
                <div>Cobrado: <span id="taxCol" style="color:white; font-weight:700">--</span></div>
                <div>Pagado: <span id="taxPd" style="color:white; font-weight:700">--</span></div>
                <div style="color:var(--info); font-size:0.7rem; margin-top:5px" id="taxOffsetDisplay"></div>
            </div>
        </div>
    </div>

    <div class="section-header">
        <span class="section-title">MIS CUENTAS</span>
        <div style="display:flex; gap:10px; align-items:center">
            <select id="accTypeFilter" onchange="renderAccounts()" style="background:var(--input); border:none; color:white; padding:5px 10px; border-radius:10px; font-size:0.85rem">
                <option value="all">Todas</option>
                <option value="debit">D√©bito</option>
                <option value="credit">Cr√©dito</option>
            </select>
            <span style="color:var(--primary); font-weight:700; cursor:pointer" onclick="openAccModal()">+ Nueva</span>
        </div>
    </div>
    <div class="acc-list" id="accList">
        <div class="loader" style="margin:20px auto"></div>
    </div>

    <div class="section-header">
        <span class="section-title">METAS DE AHORRO</span>
        <span style="color:var(--info); font-weight:700; cursor:pointer; font-size:0.85rem" onclick="openGoalsModal()">+ Crear</span>
    </div>
    <div id="goalsList" style="margin-bottom:25px"></div>

    <div class="section-header">
        <div style="display:flex;align-items:center">
            <span class="section-title">HISTORIAL</span>
            <span id="activeFilterBadge" style="display:none" class="filter-chip" onclick="clearHistoryFilter()">
                <span id="filterName">...</span> <i class="fas fa-times"></i>
            </span>
        </div>
        <input type="month" id="dateFilter" style="background:transparent; border:none; color:white; font-family:inherit; font-size:0.9rem; font-weight:700; cursor:pointer" onchange="loadTransactions()">
    </div>
    <div id="txList" class="tx-list"></div>

</div>

<div class="fab" onclick="openTxModal()"><i class="fas fa-plus"></i></div>

<div class="modal" id="modalAcc" onclick="handleOutsideClick(event, 'modalAcc')">
    <div class="sheet">
        <h3 style="text-align:center; margin-bottom:20px">Configurar Cuenta</h3>
        <form id="formAcc">
            <input type="hidden" id="editAccId"><input type="hidden" id="accColor">
            <div class="input-group"><div class="bank-grid" id="bankGrid"></div></div>
            <div class="row-2">
                <div class="input-group"><label>Nombre</label><input type="text" id="accName" required></div>
                <div class="input-group"><label>Due√±o</label><select id="accOwner"><option value="me">M√≠o</option><option value="partner">Pareja</option><option value="joint">Compartido</option></select></div>
            </div>
            <div class="row-2">
                <div class="input-group"><label>Tipo</label><select id="accType" onchange="toggleFields()"><option value="debit">D√©bito</option><option value="credit">Cr√©dito</option><option value="cash">Efectivo</option><option value="loan">Pr√©stamo</option><option value="receivable">Por Cobrar</option></select></div>
                <div class="input-group"><label>Saldo Actual</label><input type="number" id="accBalance" step="0.01" required></div>
            </div>
            <div id="fieldsCredit" style="display:none; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; margin-top:10px">
                <label style="color:var(--primary); margin-bottom:10px">Configuraci√≥n Cr√©dito</label>
                <div class="input-group"><label>Pagar desde (V√≠nculo)</label><select id="accLink"><option value="">-- Ninguna --</option></select></div>
                <div class="row-2"><div class="input-group"><label>D√≠a Corte</label><input type="number" id="vCut"></div><div class="input-group"><label>D√≠a L√≠mite Pago</label><input type="text" id="vPayDay"></div></div>
                <div class="row-2"><div class="input-group"><label>Pago M√≠nimo</label><input type="number" id="vMin" step="0.01"></div><div class="input-group"><label>Para no Intereses</label><input type="number" id="vStatement" step="0.01"></div></div>
                <div class="row-2"><div class="input-group"><label>L√≠mite Cr√©dito</label><input type="number" id="accLimit" step="0.01"></div><div class="input-group"><label>APR %</label><input type="number" id="accApr" step="0.01"></div></div>
            </div>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-top:20px">
                <label style="color:var(--info); margin-bottom:10px">Datos Dep√≥sito (Opcional)</label>
                <div class="input-group"><input type="text" id="vCard" placeholder="Tarjeta" style="font-family:monospace"></div>
                <div class="input-group" style="margin-bottom:0"><input type="text" id="vClabe" placeholder="CLABE" style="font-family:monospace"></div>
            </div>
            <button type="submit" class="btn btn-primary" id="btnSaveAcc">Guardar</button>
            <button type="button" class="btn btn-text" style="color:var(--danger); display:none" id="btnDelAcc" onclick="deleteAccount()">Eliminar</button>
            <button type="button" class="btn btn-text" onclick="closeModal('modalAcc')">Cancelar</button>
        </form>
    </div>
</div>

<div class="modal" id="modalTx" onclick="handleOutsideClick(event, 'modalTx')">
    <div class="sheet">
        <h3 style="text-align:center; margin-bottom:20px">Movimiento</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px">
            <button class="btn" style="margin:0; padding:12px" id="btnExp" onclick="setTxMode('expense')">Gasto</button>
            <button class="btn" style="margin:0; padding:12px" id="btnInc" onclick="setTxMode('income')">Ingreso</button>
            <button class="btn" style="margin:0; padding:12px" id="btnPay" onclick="setTxMode('payment')">Transferir</button>
        </div>
        <form id="formTx">
            <input type="hidden" id="editTxId"><input type="hidden" id="txMode" value="expense">
            <input type="number" id="txAmount" placeholder="$0.00" step="0.01" style="font-size:3rem; text-align:center; background:transparent; border:none; color:white; width:100%; font-weight:800; margin-bottom:20px" required>
            <div class="input-group"><input type="text" id="txDesc" placeholder="Concepto" style="text-align:center" required></div>
            <div style="display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom:20px">
                <label class="toggle-switch"><input type="checkbox" id="txInvoice"><span class="slider"></span></label>
                <span style="font-size:0.85rem; color:var(--text-muted)">Facturado (IVA)</span>
            </div>
            <input type="date" id="txDate" class="input-group" required onchange="checkDate()">
            <div id="pastDateOptions" style="display:none; background:rgba(245,158,11,0.15); border:1px solid var(--warning); padding:15px; border-radius:12px; margin-bottom:20px">
                <div style="text-align:center; color:var(--warning); font-size:0.85rem; margin-bottom:10px; font-weight:700">FECHA PASADA DETECTADA</div>
                <div class="toggle-row" style="display:flex; justify-content:space-between; margin-bottom:5px"><span>Afectar Origen</span><label class="toggle-switch"><input type="checkbox" id="chkUpdSrc" checked><span class="slider"></span></label></div>
                <div class="toggle-row" style="display:flex; justify-content:space-between"><span>Afectar Destino</span><label class="toggle-switch"><input type="checkbox" id="chkUpdDest" checked><span class="slider"></span></label></div>
            </div>
            <div id="divNormal" class="input-group"><label>Cuenta</label><select id="txAccount"></select></div>
            <div id="divPay" style="display:none">
                <div class="input-group"><label>Desde (Origen)</label><select id="payFrom"></select></div>
                <div class="input-group"><label>Hacia (Destino)</label><select id="payTo" onchange="autoSelectSource();updateDestDetails()"></select></div>
                <div id="destDetails" style="display:none; background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-top:10px">
                    <div style="color:var(--info); font-size:0.8rem; margin-bottom:5px">DATOS DESTINO:</div>
                    <div style="font-family:monospace; color:white; font-size:0.9rem"><div id="destCardVal">--</div><div id="destClabeVal">--</div></div>
                </div>
            </div>
            <div class="input-group"><label>Categor√≠a</label><select id="txCat"><option value="food">üçî Comida</option><option value="transport">‚õΩ Transporte</option><option value="home">üè† Hogar</option><option value="fun">üçø Ocio</option><option value="shopping">üõçÔ∏è Compras</option><option value="health">üíä Salud</option><option value="services">üí° Servicios</option><option value="salary">üí∞ N√≥mina</option><option value="fees">üíº Honorarios</option><option value="subs">üîÑ Suscrip.</option><option value="other">üì¶ Otro</option></select></div>
            <button type="submit" class="btn btn-primary" id="btnSaveTx">Registrar</button>
            <button type="button" class="btn btn-text" style="color:var(--danger); display:none" id="btnDelTx" onclick="deleteTransaction()">Eliminar</button>
            <button type="button" class="btn btn-text" onclick="closeModal('modalTx')">Cancelar</button>
        </form>
    </div>
</div>

<div class="modal" id="modalDetail" onclick="handleOutsideClick(event, 'modalDetail')"><div class="sheet"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 id="dtTitle" style="margin:0"></h2><div onclick="editCurrentAccount()" style="color:var(--primary);font-weight:bold;cursor:pointer">Editar</div></div><div id="dtContent"></div><button class="btn" style="background:rgba(255,255,255,0.1);color:white;margin-top:20px" onclick="filterHistoryByAccount(state.selectedAccId)">Ver Historial</button><button class="btn btn-text" onclick="closeModal('modalDetail')">Cerrar</button></div></div>
<div class="modal" id="modalTax" onclick="handleOutsideClick(event, 'modalTax')"><div class="sheet"><h3>Fiscal</h3><div class="input-group"><label>Saldo a Favor Acumulado</label><input type="number" id="taxOffsetInput" step="0.01"></div><button class="btn btn-primary" onclick="saveTaxOffset()">Guardar</button><button class="btn btn-text" onclick="closeModal('modalTax')">Cancelar</button></div></div>
<div class="modal" id="modalSettings" onclick="handleOutsideClick(event, 'modalSettings')"><div class="sheet"><h3>Configuraci√≥n de Pareja</h3><div class="input-group"><div class="row-2"><div class="input-group"><label>Mi Nombre</label><input type="text" id="confMe" placeholder="Ej: Juan"></div><div class="input-group"><label>Nombre Pareja</label><input type="text" id="confPartner" placeholder="Ej: Ana"></div></div><button class="btn btn-primary" onclick="saveSettings()">Guardar Nombres</button></div><button class="btn btn-text" style="color:var(--danger)" onclick="logout()">Cerrar Sesi√≥n</button><button class="btn btn-text" onclick="closeModal('modalSettings')">Cerrar</button></div></div>
<div class="modal" id="modalRec" onclick="handleOutsideClick(event, 'modalRec')"><div class="sheet"><h3>Pagos Fijos</h3><form id="formRec"><div class="row-2"><input type="text" id="recName" placeholder="Nombre (ej: Netflix)"><input type="number" id="recAmount" placeholder="$" step="0.01"></div><div class="input-group" style="margin-top:15px"><input type="number" id="recDay" placeholder="D√≠a Pago"><button class="btn btn-primary">Agregar</button></div></form><div id="recList" style="margin-top:20px"></div><button class="btn btn-text" onclick="closeModal('modalRec')">Cerrar</button></div></div>
<div class="modal" id="modalGoals" onclick="handleOutsideClick(event, 'modalGoals')"><div class="sheet"><h3>Meta de Ahorro</h3><form id="formGoal"><div class="row-2"><input type="text" id="goalName" placeholder="Nombre"><input type="number" id="goalAmount" placeholder="Meta Total" step="0.01"></div><div class="input-group" style="margin-top:15px"><input type="number" id="goalSaved" placeholder="Ya Ahorrado" step="0.01"><button class="btn btn-primary">Guardar</button></div></form><div id="goalsListDisplay" style="margin-top:20px"></div><button class="btn btn-text" onclick="closeModal('modalGoals')">Cerrar</button></div></div>
<div class="modal" id="modalStrategy" onclick="handleOutsideClick(event, 'modalStrategy')"><div class="sheet"><h3>Asistente de Liquidez</h3><input type="number" id="simAmount" placeholder="Ingresa tu Liquidez Total" step="0.01" style="font-size:1.5rem; text-align:center"><div style="display:flex;justify-content:center;gap:10px;margin-bottom:20px;align-items:center"><label class="toggle-switch"><input type="checkbox" id="simInvoice"><span class="slider"></span></label><span style="font-size:0.8rem;color:var(--text-muted)">Restar IVA (16%)</span></div><button class="btn btn-primary" onclick="runStrategy()">Calcular Distribuci√≥n</button><div id="stratResults" style="margin-top:25px"></div><button class="btn btn-text" onclick="closeModal('modalStrategy')">Cerrar</button></div></div>
<div class="modal" id="modalChart" onclick="handleOutsideClick(event, 'modalChart')"><div class="sheet"><h3>Resumen Gastos</h3><canvas id="expenseChart"></canvas><button class="btn btn-text" onclick="closeModal('modalChart')">Cerrar</button></div></div>

<script>
    // --- 1. CONFIG & STATE ---
    const CONSTANTS = {
        banks: [{n:'BBVA',c:'#004481'},{n:'Banorte',c:'#eb0029'},{n:'Santander',c:'#ec0000'},{n:'Citi',c:'#00558f'},{n:'Nu',c:'#820ad1'},{n:'Amex',c:'#006fcf'},{n:'Efectivo',c:'#10b981'},{n:'Klar',c:'#1e1e1e'}],
        cats: {food:'üçî Comida', transport:'‚õΩ Transporte', home:'üè† Hogar', fun:'üçø Ocio', shopping:'üõçÔ∏è Compras', health:'üíä Salud', services:'üí° Servicios', salary:'üí∞ N√≥mina', fees:'üíº Honorarios', subs:'üîÑ Suscrip.', other:'üì¶ Otro'}
    };

    const state = { 
        user: null, accounts: [], txs: [], filter: 'all', selectedAccId: null, activeFilt: null, privacy: false,
        taxOff: parseFloat(localStorage.getItem('sf_tax')) || 0,
        labels: JSON.parse(localStorage.getItem('sf_lbl')) || { me: 'M√≠o', partner: 'Pareja' },
        recs: JSON.parse(localStorage.getItem('sf_rec')) || [],
        goals: JSON.parse(localStorage.getItem('sf_goal')) || []
    };

    // --- REEMPLAZA ESTO CON TUS CREDENCIALES ---
    const cfg = {
        apiKey: "TU_API_KEY",
        authDomain: "TU_PROYECTO.firebaseapp.com",
        projectId: "TU_PROYECTO",
        storageBucket: "TU_PROYECTO.appspot.com",
        messagingSenderId: "NUMEROS",
        appId: "APP_ID"
    };
    if(!firebase.apps.length) firebase.initializeApp(cfg);
    const auth = firebase.auth(); const db = firebase.firestore();

    // --- 2. UTILS ---
    const $ = (i) => document.getElementById(i);
    const val = (i) => $(i) ? $(i).value : '';
    const num = (i) => parseFloat(val(i)) || 0;
    const fmt = (n) => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(n || 0);
    const openModal = (i) => $(i).classList.add('open');
    const closeModal = (i) => $(i).classList.remove('open');
    const handleOutsideClick = (e, id) => { if(e.target.id === id) closeModal(id); };
    const loading = (act) => $('loading-overlay').classList.toggle('active', act);
    const copyToClip = (txt) => { navigator.clipboard.writeText(txt).then(() => alert('Copiado')).catch(() => prompt("Copia manualmente:", txt)); };

    // --- 3. AUTH & INIT ---
    auth.onAuthStateChanged(u => {
        if(u) {
            state.user = u;
            $('auth-screen').style.display='none'; 
            $('app-screen').style.display='block';
            setTimeout(() => $('app-screen').classList.add('loaded'), 50);
            $('uName').innerText = u.displayName ? u.displayName.split(' ')[0].toUpperCase() : 'USUARIO'; 
            $('dateFilter').value = new Date().toISOString().slice(0,7);
            updateLabels(); renderGoals(); renderRec(); initBankGrid(); 
            startListeners();
        } else { 
            $('auth-screen').style.display='block'; 
            $('app-screen').style.display='none'; 
            $('app-screen').classList.remove('loaded');
        }
    });

    window.login = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    window.logout = () => auth.signOut();

    function startListeners() {
        db.collection('accounts').onSnapshot(s => { 
            state.accounts = []; 
            if(s.empty) { renderAccounts(); seedDataPrompt(); } 
            else {
                s.forEach(d => {
                    const data = d.data();
                    state.accounts.push({ id: d.id, ...data, balance: data.balance || 0, limit: data.limit || 0 });
                }); 
                renderAccounts(); runAdvisor(); loadTransactions();
            }
        });
    }

    async function seedDataPrompt() {
        if(localStorage.getItem('sf_seeded')) return;
        if(confirm("¬øQuieres cargar datos de ejemplo para empezar?")) {
            loading(true);
            const b = db.batch();
            b.set(db.collection('accounts').doc(), { name: 'N√≥mina', balance: 5000, type: 'debit', color: '#004481', owner: 'me', order: 1 });
            await b.commit();
            loading(false);
            localStorage.setItem('sf_seeded', 'true');
        } else localStorage.setItem('sf_seeded', 'true');
    }

    // --- 4. RENDER LOGIC ---
    function renderAccounts() {
        const list = $('accList'); list.innerHTML=''; 
        state.accounts.sort((a,b) => (a.order||0)-(b.order||0));
        
        const typeFilter = $('accTypeFilter')?.value || 'all';
        const filtered = state.accounts.filter(a => {
            const ownerMatch = state.filter === 'all' || a.owner === state.filter || a.owner === 'joint';
            const typeMatch = typeFilter === 'all' ? true : (typeFilter === 'debit' ? ['debit','cash','receivable'].includes(a.type) : ['credit','loan'].includes(a.type));
            return ownerMatch && typeMatch;
        });

        let assets=0, debt=0, pending=0;
        // Logic for Joint Accounts: If in privacy mode (me), count 50% of joint. If all, count 100%.
        state.accounts.forEach(a => {
            if (state.filter === 'all' || a.owner === state.filter || (a.owner === 'joint' && !state.privacy)) {
                if(['credit','loan'].includes(a.type)) debt += a.balance;
                else if(a.type === 'receivable') pending += a.balance;
                else assets += a.balance;
            } else if (a.owner === 'joint' && state.privacy && state.filter === 'me') {
                // In private mode "me", show 50% of joint assets/debt
                if(['credit','loan'].includes(a.type)) debt += (a.balance/2);
                else assets += (a.balance/2);
            }
        });
        
        const goalsTotal = state.goals.reduce((s,g) => s + (g.saved||0), 0);
        
        const net = assets - debt - goalsTotal;
        $('netDisplay').innerText = fmt(net); 
        $('liqDisplay').innerText = fmt(assets - goalsTotal); 
        $('assetDisplay').innerText = fmt(assets); 
        $('debtDisplay').innerText = fmt(debt); 
        $('goalsDisplay').innerText = fmt(goalsTotal); 
        $('pendDisplay').innerText = fmt(pending);
        
        // Privacy Blur
        const blurElements = document.querySelectorAll('.net-val, .stat-val');
        blurElements.forEach(el => {
            if(state.privacy && state.filter !== 'me') el.classList.add('blur');
            else el.classList.remove('blur');
        });

        if(filtered.length === 0) list.innerHTML = `<div class="empty-state" onclick="openAccModal()">+ Agregar primera cuenta</div>`;

        filtered.forEach(a => {
            let extraInfo = '';
            if(a.type === 'credit' && a.limit > 0) {
                const pct = Math.min(100, (a.balance / a.limit) * 100);
                const color = pct > 70 ? 'var(--danger)' : (pct > 30 ? 'var(--warning)' : 'var(--success)');
                extraInfo = `<div class="credit-bar-bg"><div class="credit-bar-fill" style="width:${pct}%;background:${color};"></div></div><div class="cut-info"><span>${pct.toFixed(0)}% Uso</span><span>Corte: ${a.vault?.cut||'--'}</span></div>`;
            }
            
            // Privacy Mask for Cards
            let balDisplay = fmt(a.balance);
            if(state.privacy && a.owner !== 'me' && a.owner !== 'joint') balDisplay = '****';
            
            const card = document.createElement('div'); card.className = 'bank-card';
            card.style.background = `linear-gradient(135deg,${a.color||'#1e293b'},#0f172a)`;
            card.onclick = () => { if(!state.privacy || a.owner === 'me' || a.owner === 'joint') openDetail(a.id) };
            card.innerHTML = `<div style="display:flex;justify-content:space-between"><span class="badge">${a.type.toUpperCase()}</span></div><div><div style="opacity:.8">${a.name}</div><div style="font-size:1.6rem;font-weight:700">${balDisplay}</div>${extraInfo}</div>`;
            list.appendChild(card);
        });
    }

    function togglePrivacy() {
        state.privacy = !state.privacy;
        const btn = $('privacyBtn');
        const txt = $('privacyText');
        if(state.privacy) {
            btn.classList.add('active');
            txt.innerText = 'Privado';
            btn.innerHTML = '<i class="fas fa-eye-slash"></i> <span id="privacyText">Privado</span>';
            // Force filter to me
            if(state.filter === 'all' || state.filter === 'partner') setFilter('me');
        } else {
            btn.classList.remove('active');
            txt.innerText = 'Visible';
            btn.innerHTML = '<i class="fas fa-eye"></i> <span id="privacyText">Visible</span>';
        }
        renderAccounts();
    }

    function loadTransactions() {
        const m = $('dateFilter').value; if(!m) return;
        const l = $('txList'); l.innerHTML = '<div class="loader" style="margin:20px auto"></div>';

        const startDate = m + "-01";
        const [year, month] = m.split('-').map(Number);
        const lastDay = new Date(year, month, 0).getDate();
        const endDate = `${m}-${lastDay}`;

        db.collection('transactions').where('date', '>=', startDate).where('date', '<=', endDate).orderBy('date', 'desc').limit(100)
            .onSnapshot(s => {
                state.txs = []; let collected = 0, paid = 0;
                s.forEach(d => { 
                    const t = {id:d.id, ...d.data()}; state.txs.push(t); 
                    if(t.invoice) { 
                        const base = (t.amount || 0) - ((t.amount || 0) / 1.16); 
                        if(t.type === 'income' || (t.type === 'transfer' && t.desc.includes('Cobro'))) collected += base; 
                        if(t.type === 'expense') paid += base; 
                    } 
                });
                renderTransactions(); updateTax(collected, paid);
            }, (error) => { console.error(error); l.innerHTML = '<div class="empty-state" style="color:var(--danger)">Error de conexi√≥n</div>'; });
    }

    function renderTransactions() {
        const l = $('txList'); l.innerHTML = '';
        let filtered = state.activeFilt ? state.txs.filter(t => t.accId === state.activeFilt || t.fromId === state.activeFilt || t.toId === state.activeFilt) : state.txs;
        
        // Privacy Filter for History
        if(state.privacy) {
            filtered = filtered.filter(t => {
                const acc = state.accounts.find(a => a.id === (t.accId || t.fromId));
                return acc && (acc.owner === 'me' || acc.owner === 'joint');
            });
        }

        const badge = $('activeFilterBadge');
        if(state.activeFilt) {
            const acc = state.accounts.find(a=>a.id===state.activeFilt);
            $('filterName').innerText = acc ? acc.name : 'Cuenta';
            badge.style.display = 'inline-flex';
        } else badge.style.display = 'none';

        if(filtered.length === 0) { l.innerHTML = '<div class="empty-state">Sin movimientos</div>'; return; }
        
        filtered.forEach(t => {
            const color = t.type === 'expense' ? 'var(--danger)' : (t.type === 'income' ? 'var(--success)' : 'var(--info)');
            const icon = t.type === 'transfer' ? 'fa-exchange-alt' : (t.type === 'expense' ? 'fa-arrow-down' : 'fa-arrow-up');
            
            let desc = t.desc;
            if(t.type === 'transfer') { 
                const fr = state.accounts.find(a => a.id === t.fromId); 
                const to = state.accounts.find(a => a.id === t.toId); 
                desc = `${fr ? fr.name : 'Desconocido'} ‚ûú ${to ? to.name : 'Desconocido'}`; 
            }
            
            const div = document.createElement('div'); div.className = 'tx-item';
            div.onclick = () => openEditTx(t);
            div.innerHTML = `<div style="display:flex;align-items:center"><div class="tx-icon" style="background:rgba(255,255,255,0.05);color:${color}"><i class="fas ${icon}"></i></div><div><div style="font-weight:700">${desc} ${t.invoice ? '<i class="fas fa-file-invoice" style="font-size:0.7rem;margin-left:5px"></i>' : ''}</div><small style="color:gray">${t.date}</small></div></div><div style="font-weight:700;color:${color}">${fmt(t.amount)}</div>`;
            l.appendChild(div);
        });
    }

    // --- 5. LOGIC & ACTIONS ---
    $('formAcc').onsubmit = async (e) => {
        e.preventDefault(); loading(true);
        try {
            const id = val('editAccId'); const link = val('accLink');
            const data = {
                name: val('accName'), color: val('accColor'), owner: val('accOwner'), type: val('accType'),
                balance: num('accBalance'), limit: num('accLimit'), apr: num('accApr'), linkedAccId: link || null,
                vault: { card: val('vCard'), clabe: val('vClabe'), cut: val('vCut'), payDay: val('vPayDay'), minPay: num('vMin'), statementBal: num('vStatement') }
            };
            if(id) await db.collection('accounts').doc(id).update(data); 
            else await db.collection('accounts').add(data);
            closeModal('modalAcc');
        } catch(x){ alert(x.message) } 
        loading(false);
    };

    function openAccModal() { $('formAcc').reset(); $('editAccId').value = ''; $('btnDelAcc').style.display='none'; populateLinked(null); toggleFields(); initBankGrid(); openModal('modalAcc'); }
    
    function editCurrentAccount() { 
        closeModal('modalDetail'); const a = state.accounts.find(x => x.id === state.selectedAccId); if(!a) return;
        $('editAccId').value = a.id; $('accName').value = a.name; $('accColor').value = a.color; $('accOwner').value = a.owner; $('accType').value = a.type; $('accBalance').value = a.balance; 
        if(a.vault) { $('vCard').value = a.vault.card || ''; $('vClabe').value = a.vault.clabe || ''; $('vCut').value = a.vault.cut || ''; $('vPayDay').value = a.vault.payDay || ''; $('vMin').value = a.vault.minPay || ''; $('vStatement').value = a.vault.statementBal || ''; }
        $('accApr').value = a.apr || ''; populateLinked(a.id); $('accLink').value = a.linkedAccId || ''; toggleFields(); $('btnDelAcc').style.display='block'; openModal('modalAcc'); 
    }

    async function deleteAccount() { if(confirm("¬øEst√°s seguro?")) { loading(true); await db.collection('accounts').doc(val('editAccId')).delete(); loading(false); closeModal('modalAcc'); } }

    $('formTx').onsubmit = async (e) => {
        e.preventDefault(); loading(true);
        const id = val('editTxId'), amt = num('txAmount'), m = val('txMode'), dt = val('txDate');
        const past = new Date(dt+"T00:00:00") < new Date().setHours(0,0,0,0);
        let updSrc = true, updDest = true;
        if(past && !id) { updSrc = $('chkUpdSrc').checked; updDest = $('chkUpdDest').checked; }

        const data = { amount: amt, date: dt, desc: val('txDesc'), cat: val('txCat'), invoice: $('txInvoice').checked, type: m === 'payment' ? 'transfer' : m, fromId: m === 'payment' ? val('payFrom') : null, toId: m === 'payment' ? val('payTo') : null, accId: m !== 'payment' ? val('txAccount') : null, noImpact: (!updSrc && !updDest) };

        try {
            if(id) await db.collection('transactions').doc(id).update(data);
            else {
                const batch = db.batch(); const ref = db.collection('transactions').doc();
                if(m === 'payment') {
                    const fr = state.accounts.find(a => a.id === data.fromId), to = state.accounts.find(a => a.id === data.toId);
                    if(fr && updSrc) batch.update(db.collection('accounts').doc(fr.id), {balance: fr.balance - amt});
                    if(to && updDest) batch.update(db.collection('accounts').doc(to.id), {balance: (['credit','loan'].includes(to.type) ? to.balance - amt : to.balance + amt)});
                } else {
                    const acc = state.accounts.find(x => x.id === data.accId);
                    if(acc && updSrc) { 
                        let newBal = acc.balance; const isCredit = ['credit','loan'].includes(acc.type);
                        if(m === 'expense') newBal += (isCredit ? amt : -amt); else newBal += (isCredit ? -amt : amt); 
                        batch.update(db.collection('accounts').doc(acc.id), {balance: newBal}); 
                    }
                }
                batch.set(ref, data); await batch.commit();
            }
            closeModal('modalTx'); 
            $('txList').scrollIntoView({behavior: "smooth"});
        } catch(err) { console.error(err); alert("Error"); }
        loading(false);
    };

    function openTxModal() { 
        $('editTxId').value = ''; $('txDate').valueAsDate = new Date(); 
        setTxMode('expense'); $('btnDelTx').style.display='none'; $('btnSaveTx').innerText="Registrar";
        checkDate(); openModal('modalTx'); 
    }

    function openEditTx(tx) { 
        $('editTxId').value = tx.id; $('txAmount').value = tx.amount; $('txDesc').value = tx.desc; $('txDate').value = tx.date; 
        $('txInvoice').checked = !!tx.invoice; setTxMode(tx.type === 'transfer' ? 'payment' : tx.type); 
        if(tx.type === 'transfer') { $('payFrom').value = tx.fromId; $('payTo').value = tx.toId; updateDestDetails(); } 
        else $('txAccount').value = tx.accId;
        $('txCat').value = tx.cat; checkDate(); $('btnDelTx').style.display='block'; $('btnSaveTx').innerText = "Actualizar"; openModal('modalTx'); 
    }

    async function deleteTransaction() { if(confirm("¬øEliminar?")) { loading(true); await db.collection('transactions').doc(val('editTxId')).delete(); loading(false); closeModal('modalTx'); } }

    // --- Helpers ---
    function setTxMode(m) { 
        $('txMode').value = m; 
        ['btnExp','btnInc','btnPay'].forEach(b => $(b).style.background = 'rgba(255,255,255,0.1)'); 
        $((m === 'expense' ? 'btnExp' : (m === 'income' ? 'btnInc' : 'btnPay'))).style.background = 'var(--primary)';
        $('divPay').style.display = m === 'payment' ? 'block' : 'none'; $('divNormal').style.display = m === 'payment' ? 'none' : 'block'; 
        const pop = (id) => { const s=$(id); s.innerHTML=''; state.accounts.forEach(a=>s.innerHTML+=`<option value="${a.id}">${a.name}</option>`); };
        pop('payFrom'); pop('payTo'); pop('txAccount');
        if(m === 'payment') updateDestDetails();
    }
    
    function autoSelectSource() {
        const destId = val('payTo'); const dest = state.accounts.find(x => x.id === destId);
        if(dest && dest.linkedAccId) $('payFrom').value = dest.linkedAccId;
    }

    function updateDestDetails() { 
        const id = val('payTo'); const a = state.accounts.find(x => x.id === id); const box = $('destDetails'); 
        if(!a) return;
        const infoSrc = (a.linkedAccId ? state.accounts.find(x=>x.id===a.linkedAccId) : a);
        if(infoSrc && infoSrc.vault && (infoSrc.vault.card || infoSrc.vault.clabe)) {
            box.style.display='block'; $('destCardVal').innerText = infoSrc.vault.card || '--'; $('destClabeVal').innerText = infoSrc.vault.clabe || '--';
        } else box.style.display = 'none'; 
    }

    function checkDate() { const d = val('txDate'); $('pastDateOptions').style.display = new Date(d+"T00:00:00") < new Date().setHours(0,0,0,0) ? 'block' : 'none'; }
    function quickPay(desc, amount, type, accId) { openTxModal(); $('txDesc').value = desc; $('txAmount').value = amount; setTxMode('payment'); $('payTo').value = accId; autoSelectSource(); updateDestDetails(); closeModal('modalStrategy'); }
    function filterHistoryByAccount(id) { state.activeFilt = id; closeModal('modalDetail'); loadTransactions(); $('txList').scrollIntoView({behavior: "smooth"}); }
    function clearHistoryFilter() { state.activeFilt = null; loadTransactions(); }

    // --- Fiscal & Strategy & Extras ---
    function updateTax(c, p) { const net = c - p - state.taxOff; $('taxPayable').innerText = fmt(net); $('taxCol').innerText = fmt(c); $('taxPd').innerText = fmt(p); $('taxPayable').style.color = net > 0 ? 'var(--danger)' : 'var(--success)'; $('taxOffsetDisplay').innerText = state.taxOff > 0 ? `Ajuste: -${fmt(state.taxOff)}` : ''; }
    function openTaxModal() { $('taxOffsetInput').value = state.taxOff; openModal('modalTax'); }
    function saveTaxOffset() { state.taxOff = num('taxOffsetInput'); localStorage.setItem('sf_tax', state.taxOff); closeModal('modalTax'); loadTransactions(); }

    function runAdvisor() { 
        const debts = state.accounts.filter(a => ['credit','loan'].includes(a.type) && a.balance > 0).sort((a,b)=>(b.apr||0)-(a.apr||0));
        $('advisor-content').innerHTML = debts.length > 0 ? `Prioridad: <b>${debts[0].name}</b> (${debts[0].apr || 0}% APR)` : 'Finanzas sanas. ¬°Ahorra!';
        $('advisor').style.display = 'block'; 
    }

    function runStrategy() {
        let m = num('simAmount'), h = '';
        if($('simInvoice').checked) { const v = m - (m / 1.16); m -= v; h += `<div class="plan-step" style="border-left-color:var(--warning)">Apartar IVA: ${fmt(v)}</div>`; }
        state.recs.forEach(r => { if(!state.txs.some(t => t.desc.includes(r.name))) { m -= r.amt; h += `<div class="plan-step">Pagar ${r.name} (${fmt(r.amt)})</div>`; } });
        state.accounts.filter(a => ['credit','loan'].includes(a.type) && a.balance > 0).forEach(d => { if(m > 0 && d.vault?.minPay) { const p = Math.min(m, d.vault.minPay); m -= p; h += `<div class="plan-step urgent" onclick="quickPay('Pago ${d.name}',${p},'payment','${d.id}')">Pago M√≠n ${d.name} (${fmt(p)}) <i class="fas fa-arrow-right"></i></div>`; } });
        h += `<div style="text-align:center;color:${m>0?'var(--success)':'var(--danger)'};margin-top:10px;font-weight:700;font-size:1.2rem">${m>0?'Libre':'Faltante'}: ${fmt(m)}</div>`;
        $('stratResults').innerHTML = h;
    }

    function renderRec(){ $('recList').innerHTML = state.recs.map((r,i) => `<div class="plan-step" style="margin-bottom:5px; border-left-color:var(--primary)"><span>${r.name} (${fmt(r.amt)}) <small>D√≠a ${r.day}</small></span><i class="fas fa-trash" style="color:var(--danger); padding:5px" onclick="delRec(${i})"></i></div>`).join(''); }
    $('formRec').onsubmit = (e) => { e.preventDefault(); state.recs.push({name:val('recName'), amt:num('recAmount'), day:val('recDay')}); localStorage.setItem('sf_rec', JSON.stringify(state.recs)); $('formRec').reset(); renderRec(); };
    function delRec(i){ state.recs.splice(i,1); localStorage.setItem('sf_rec', JSON.stringify(state.recs)); renderRec(); }

    function renderGoals(){ const l=$('goalsList'); l.innerHTML = ''; state.goals.forEach((g,i) => { const p = Math.min(100, (g.saved / g.amount) * 100); l.innerHTML += `<div class="goal-item"><div><div style="font-weight:600">${g.name} <span style="font-size:0.8rem;color:var(--text-muted)">(${fmt(g.saved)} / ${fmt(g.amount)})</span></div><div class="goal-progress"><div class="goal-fill" style="width:${p}%"></div></div></div><i class="fas fa-trash" style="color:var(--danger);cursor:pointer;padding:10px" onclick="delGoal(${i})"></i></div>`; }); }
    $('formGoal').onsubmit = (e) => { e.preventDefault(); state.goals.push({name:val('goalName'), amount:num('goalAmount'), saved:num('goalSaved')}); localStorage.setItem('sf_goal', JSON.stringify(state.goals)); renderGoals(); renderAccounts(); closeModal('modalGoals'); };
    function delGoal(i){ state.goals.splice(i,1); localStorage.setItem('sf_goal', JSON.stringify(state.goals)); renderGoals(); renderAccounts(); }

    function openChartModal(){ openModal('modalChart'); const ctx = $('expenseChart').getContext('2d'); const d = {}; state.txs.filter(t => t.type === 'expense').forEach(t => { d[t.cat] = (d[t.cat] || 0) + t.amount }); if(window.myChart) window.myChart.destroy(); if(Object.keys(d).length === 0) { ctx.font="14px Outfit"; ctx.fillStyle="white"; ctx.textAlign="center"; ctx.fillText("Sin datos", 150, 75); return; } window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(d).map(k => CONSTANTS.cats[k] || k), datasets: [{ data: Object.values(d), backgroundColor: ['#6366f1','#ef4444','#10b981','#f59e0b','#8b5cf6', '#ec4899', '#14b8a6', '#f97316'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } } }); }

    // --- Details & Settings ---
    function openDetail(id) { 
        state.selectedAccId = id; const a = state.accounts.find(x => x.id === id); 
        let h = `<div style="font-size:2.5rem;font-weight:800;text-align:center;margin:20px 0">${fmt(a.balance)}</div>`;
        if(['credit','loan'].includes(a.type) && a.vault) h += `<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:16px;margin-top:15px"><div class="detail-row"><span>Corte:</span><span class="detail-val">D√≠a ${a.vault.cut || '--'}</span></div><div class="detail-row"><span>L√≠mite Pago:</span><span class="detail-val">D√≠a ${a.vault.payDay || '--'}</span></div><div class="detail-row"><span class="detail-label">Pago M√≠n:</span><span class="detail-val" style="color:var(--warning)">${fmt(a.vault.minPay || 0)}</span></div><div class="detail-row"><span class="detail-label">Para no Intereses:</span><span class="detail-val" style="color:var(--success)">${fmt(a.vault.statementBal || 0)}</span></div></div>`;
        
        // Secure Reveal for Vault
        if(a.vault && (a.vault.card || a.vault.clabe)) {
            h += `<div style="margin-top:15px">`;
            if(a.vault.card) h += `<div class="detail-copy-box" onclick="toggleSecure(this)"><span>Tarjeta</span><span class="secure-reveal">${a.vault.card} <i class="far fa-eye" style="margin-left:5px"></i></span></div>`;
            if(a.vault.clabe) h += `<div class="detail-copy-box" onclick="toggleSecure(this)"><span>CLABE</span><span class="secure-reveal">${a.vault.clabe} <i class="far fa-eye" style="margin-left:5px"></i></span></div>`;
            h += `</div>`;
        }
        $('dtContent').innerHTML = h; $('dtTitle').innerText = a.name; openModal('modalDetail'); 
    }
    
    function toggleSecure(el) {
        const span = el.querySelector('.secure-reveal');
        if(span.classList.contains('visible')) {
            // Copy action if visible
            copyToClip(span.innerText.trim());
        } else {
            span.classList.add('visible');
        }
    }

    function setFilter(f) { 
        state.filter = f; 
        ['tabAll','tabMe','tabPartner'].forEach(b => $(b).className = 'pt-btn'); 
        $(f === 'all' ? 'tabAll' : (f === 'me' ? 'tabMe' : 'tabPartner')).classList.add('active'); 
        
        // If joint view and privacy is on, warn or disable
        if(state.privacy && f !== 'me') {
             // Optional: Alert or visual cue
        }
        renderAccounts(); 
    }
    
    function saveSettings() { state.labels.me = val('confMe'); state.labels.partner = val('confPartner'); localStorage.setItem('sf_names', JSON.stringify(state.labels)); updateLabels(); closeModal('modalSettings'); }
    function updateLabels() { 
        $('tabMe').innerText = state.labels.me || 'M√≠o'; 
        $('tabPartner').innerText = state.labels.partner || 'Pareja'; 
        const s = $('accOwner'); 
        if(s) { s.options[0].text = state.labels.me || 'M√≠o'; s.options[1].text = state.labels.partner || 'Pareja'; } 
        // Pre-fill modal
        $('confMe').value = state.labels.me || '';
        $('confPartner').value = state.labels.partner || '';
        renderAccounts(); 
    }
    function toggleFields() { const t = val('accType'), c = ['credit','loan'].includes(t); $('fieldsCredit').style.display = c ? 'block' : 'none'; $('vPayDay').type = t === 'loan' ? 'date' : 'text'; }
    function populateLinked(cid) { const s = $('accLink'); s.innerHTML = '<option value="">-- Ninguna --</option>'; state.accounts.filter(a => ['debit','cash'].includes(a.type) && a.id !== cid).forEach(a => s.innerHTML += `<option value="${a.id}">${a.name}</option>`); }
    function initBankGrid() { const g = $('bankGrid'); g.innerHTML = ''; CONSTANTS.banks.forEach(b => { const d = document.createElement('div'); d.className = 'bank-chip'; d.innerText = b.n; d.style.borderLeft = `3px solid ${b.c}`; d.onclick = () => { $('accColor').value = b.c; if(!val('accName')) $('accName').value = b.n; document.querySelectorAll('.bank-chip').forEach(e => e.classList.remove('selected')); d.classList.add('selected'); }; g.appendChild(d); }); }

    // --- Shortcuts ---
    window.openRecModal = () => { renderRec(); openModal('modalRec'); };
    window.openGoalsModal = () => { openModal('modalGoals'); };
    window.openStrategyModal = () => { openModal('modalStrategy'); };
    window.openTaxModal = () => { openModal('modalTax'); };
</script>
</body>
</html>
